{"version":3,"sources":["scripts/main.js"],"names":["this","MyOD","Backbone","Marionette","Application","on","searchModel","Models","SearchModel","layout","Main","Layout","history","start","pushState","root","navigate","trigger","setClasses","route","options","search","getRoute","navigate404","replace","queryStringToObject","result","q","getFragment","split","pairs","_","each","pair","decodeURIComponent","getBloodhound","bloodhound","Bloodhound","datumTokenizer","tokenizers","obj","whitespace","queryTokenizer","limit","remote","url","config","api","rateLimitWait","query","filter","response","data","onBeforeDestroy","stop","module","Utils","App","$","MapManager","Object","extend","initialize","bindAll","globalChannel","Wreqr","radio","channel","_loadDojo","reqres","setHandler","updateStyle","dfd","Deferred","dojoReady","promise","window","dojo","resolve","include","require","map","destroy","proxyEvent","evtName","evt","vent","createMap","mapDiv","self","mapOpts","center","zoom","basemap","smartNavigation","navigationMode","fitExtent","minZoom","wrapAround180","esri","Map","onLoad","opts","disableScrollWheelZoom","coords","extent","geometry","Extent","SpatialReference","wkid","setExtent","hitch","getDatasetInfoTemplate","dataset","displayFieldName","get","title","InfoTemplate","getDatasetLayerOpts","mode","layers","FeatureLayer","MODE_AUTO","outFields","infoTemplate","geometryType","_addDefaultSymbols","addDataset","datasetLayer","layerDefinition","drawingInfo","setRenderer","_createRendererFromJson","renderer","onLoadDataset","addLayer","layer","minScale","maxScale","_applyRenderer","smap","graphics","length","attributes","field","redraw","refresh","type","smartMapping","createClassedColorRenderer","then","heatmap","createHeatmapRenderer","createClassedSizeRenderer","layerOptions","util","defaults","defaultPolygonRenderer","defaultPointRenderer","defaultLineRenderer","rendererJson","SimpleRenderer","ClassBreaksRenderer","xmin","ymin","xmax","ymax","spatialReference","serviceUrls","geometryService","label","description","symbol","color","size","angle","xoffset","yoffset","style","outline","width","Base","SearchView","ItemView","onRender","initTypeahead","highlight","minLength","hint","datasets","name","displayKey","item","templates","empty","source","ttAdapter","ui","typeahead","onTypeaheadSelected","model","set","page","updateModel","onKeyDown","e","which","preventDefault","onKeyUp","onSearchButtonClick","Model","per_page","total_count","sort_by","queryStringParams","getQueryString","pick","toJSON","param","getUrl","JST","datasets/templates/dataset","__t","__p","escape","moment","created_at","calendar","updated_at","tags","join","datasets/templates/table-row","Array","prototype","fields","datasets/templates/table","from","toLocaleString","to","total","sortField","alias","pages","error/templates/404","error/templates/500","home/templates/home","results/templates/results-empty","results/templates/results-item","fromNow","results/templates/results-loading","results/templates/results","collectionIsLoading","HeaderSearchView","listenTo","onQueryChanged","el","template","events","keydown #header-search","keyup #header-search","click #header-search-btn","typeahead:selected input","LayoutView","headerSearchView","render","regions","main","click #home-link","navigateHome","metaKey","ctrlKey","indexOf","$el","removeClass","addClass","HomeModule","View","keydown #search","keyup #search","click #search-btn","id","onDomRefresh","focus","Controller","initUi","view","getRegion","show","Router","AppRouter","appRoutes","addInitializer","controller","API","homeController","DatasetModel","arcgis_online_item_url","owner","views","thumbnail_url","parse","getNumericFields","contains","DatasetCollection","Collection","resp","metadata","query_parameters","stats","ResultsModule","tagName","click","onClick","LoadingView","className","EmptyView","CompositeView","selectDataset","childView","childViewContainer","getEmptyView","click ul.pagination a","modelEvents","change:total_count","collectionEvents","sync","error","onCollectionSync","childModel","onPageClicked","stopPropagation","target","closest","templateHelpers","active","info","len","Math","round","total_pages","ceil","end","clone","i","push","prevUrl","prevPage","nextUrl","nextPage","firstPage","lastPage","collection","fetch","cache","datasets(/)","queryObj","resultsController","DatasetRow","RowCollection","queryCapabilities","supportsPagination","supports_pagination","orderBy","perPage","orderByAsc","getQueryUrl","rows","features","first","DatasetsModule","TableRowView","TableView","click ul.pagination li a","click thead th","reset","childViewOptions","showPagination","sortClass","sortIconClass","totalPages","anchor","li","hasClass","sort","mapManager","tableContainer","change","baseUrl","tableView","toLowerCase","done","coordinates","initSmaps","numerics","fieldName","getStats","getGeometryType","yukiOptions","statistics","schemes","getSchemes","yuki","remove","Yuki","changeAttribute","changeRamp","_execStyleMap","fieldObj","findWhere","geomType","theme","styleType","styles","selectedScheme","index","secondarySchemes","scheme","request","buildPointLegend","breaks","onDestroy","onModelFetched","fail","datasets/:id(/)","datasetsController","ErrorModule","getTemplate","errorCode","404","500","initController","errorController","error404","error500"],"mappings":"AAEKA,KAAKC,MAA6B,gBAAdD,MAAKC,OAC5BD,KAAKC,SAGP,WACE,YAEAA,MAAO,GAAIC,UAASC,WAAWC,YAE/BH,KAAKI,GAAG,eAAgB,WACtBL,KAAKM,YAAc,GAAIL,MAAKM,OAAOC,YACnCR,KAAKS,OAAS,GAAIR,MAAKS,KAAKC,SAI9BV,KAAKI,GAAG,QAAS,WACXH,SAASU,UAINV,SAASU,QAAQC,OAAQC,WAAW,EAAOC,KAAM,wBACpDd,KAAKe,SAAS,OAASC,SAAQ,KAInCf,SAASU,QAAQP,GAAG,QAASL,KAAKS,OAAOS,YACzClB,KAAKS,OAAOS,eAGdjB,KAAKe,SAAW,SAAUG,EAAOC,GAC/BlB,SAASU,QAAQI,SAASG,EAAOC,IAGnCnB,KAAKoB,OAAS,WACZ,GAAIF,GAAQlB,KAAKK,YAAYgB,UAC7BrB,MAAKe,SAASG,GAASF,SAAQ,KAGjChB,KAAKsB,YAAc,WACjBtB,KAAKe,SAAS,OAASC,SAAS,EAAMO,SAAS,KAGjDvB,KAAKwB,oBAAsB,WACzB,GAAIC,MAEAC,EAAIzB,SAASU,QAAQgB,cAAcC,MAAM,KAAK,EAElD,IAAIF,EAAG,CACL,GAAIG,GAAQH,EAAEE,MAAM,IAEpBE,GAAEC,KAAKF,EAAO,SAASG,GACrBA,EAAOA,EAAKJ,MAAM,KAEhBH,EAAOO,EAAK,IADE,MAAZA,EAAK,GACWA,EAAK,GAAGT,QAAQ,MAAO,MAAQ,GAE/BU,mBAAmBD,EAAK,IAAM,MAKtD,MAAOP,IAGTzB,KAAKkC,cAAgB,WAkBnB,MAjBKnC,MAAKoC,aACRpC,KAAKoC,WAAa,GAAIC,aACpBC,eAAgBD,WAAWE,WAAWC,IAAIC,WAAW,SACrDC,eAAgBL,WAAWE,WAAWE,WACtCE,MAAO,GACPC,QACEC,IAAK5C,KAAK6C,OAAOC,IAAM,0CACvBC,cAAe,IACfxB,QAAS,SAAUqB,EAAKI,GACtB,MAAOJ,GAAIrB,QAAQ,SAAUyB,IAE/BC,OAAQ,SAASC,GACf,MAAOA,GAAWA,EAASC,aAK5BpD,KAAKoC,YAGdnC,KAAKoD,gBAAkB,WACrBnD,SAASU,QAAQ0C,WAKrB,WAEE,YAEArD,MAAKsD,OAAO,QAAS,SAAUC,EAAOC,EAAKvD,EAAUC,EAAYuD,EAAG3B,GAElEyB,EAAMG,WAAaxD,EAAWyD,OAAOC,QAEnCC,WAAY,WACV/B,EAAEgC,QAAQ/D,KAAM,eAEhBA,KAAKgE,cAAgB9D,EAAS+D,MAAMC,MAAMC,QAAQ,UAElDnE,KAAKoE,YACLX,EAAIY,OAAOC,WAAW,qBAAsBtE,KAAKuE,cAOnDH,UAAW,WACT,GAAII,GAAMd,EAAEe,UACZzE,MAAK0E,UAAYF,EAAIG,UAEhBC,OAAOC,KAWVL,EAAIM,UATJC,QAAQ,sCAAuC,WAE7CC,SAAS,WAAY,2BAA4B,uBAAwB,kBAAmB,WAC1FR,EAAIM,eAWZzB,gBAAiB,WACXrD,KAAKiF,KACPjF,KAAKiF,IAAIC,WAIbC,WAAY,SAAUC,EAASC,GAC7BrF,KAAKgE,cAAcsB,KAAKrE,QAAQmE,EAASC,IAK3CE,UAAW,SAAUC,EAAQpE,GAC3B,GAAIqE,GAAOzF,KACP0F,GACFC,QAAU,QAAS,QACnBC,KAAM,EACNC,QAAS,YACTC,iBAAgB,EAChBC,eAAgB,iBAChBC,WAAU,EACVC,QAAS,EACTC,eAAc,EAGhBlG,MAAKiF,IAAM,GAAIkB,MAAKC,IAAIZ,EAAQE,EAGhC,IAAIW,GAAS,SAASC,GAElB,GADAA,EAAKrB,IAAIsB,yBACLnF,EAAQoF,OAAQ,CAClB,GAAIC,GAAS,GAAIN,MAAKO,SAASC,OAAOvF,EAAQoF,OAAO,GAAG,GAAIpF,EAAQoF,OAAO,GAAG,GAAIpF,EAAQoF,OAAO,GAAG,GAAIpF,EAAQoF,OAAO,GAAG,GAAI,GAAIL,MAAKS,kBAAmBC,KAAM,OAChKP,GAAKrB,IAAI6B,UAAUL,GAErBhB,EAAKN,WAAW,YAIpBnF,MAAKiF,IAAI5E,GAAG,OAAQwE,KAAKkC,MAAM/G,KAAMqG,IACrCrG,KAAKiF,IAAI5E,GAAG,gBAAiBwE,KAAKkC,MAAM/G,KAAMA,KAAKmF,WAAY,sBAC/DnF,KAAKiF,IAAI5E,GAAG,YAAawE,KAAKkC,MAAM/G,KAAMA,KAAKmF,WAAY,mBAM7D6B,uBAAwB,SAAUC,GAEhC,GAAIC,GAAmBD,EAAQE,IAAI,iBAC/BC,EAAQF,EAAmB,KAAOA,EAAmB,IAAM,YAC/D,OAAO,IAAIf,MAAKkB,aAAaD,EAAO,SAGtCE,oBAAqB,SAAUL,GAC7B,GAAIX,IAEFiB,KAAMpB,KAAKqB,OAAOC,aAAaC,UAC/BC,UAAW,IACXC,aAAc5H,KAAKgH,uBAAuBC,GAC1CY,aAAcZ,EAAQE,IAAI,iBAI5B,OADAnH,MAAK8H,mBAAmBxB,GACjBA,GAGTyB,WAAY,SAAUd,GACpB,GAAIX,GAAOtG,KAAKsH,oBAAoBL,EACpCjH,MAAKgI,aAAe,GAAI7B,MAAKqB,OAAOC,aAAaR,EAAQE,IAAI,OAAQb,GAElEA,EAAK2B,iBAAmB3B,EAAK2B,gBAAgBC,aAE9ClI,KAAKgI,aAAaG,YAAYnI,KAAKoI,wBAAwB9B,EAAK2B,gBAAgBC,YAAYG,WAG9FrI,KAAKgI,aAAa3H,GAAG,OAAQL,KAAKsI,eAGlCtI,KAAKgI,aAAa3H,GAAG,OAAQwE,KAAKkC,MAAM/G,KAAMA,KAAKmF,WAAY,0BAC/DnF,KAAKgI,aAAa3H,GAAG,QAASwE,KAAKkC,MAAM/G,KAAMA,KAAKmF,WAAY,2BAChEnF,KAAKgI,aAAa3H,GAAG,uBAAwBwE,KAAKkC,MAAM/G,KAAMA,KAAKmF,WAAY,0CAC/EnF,KAAKgI,aAAa3H,GAAG,aAAcwE,KAAKkC,MAAM/G,KAAMA,KAAKmF,WAAY,gCAErEnF,KAAKiF,IAAIsD,SAASvI,KAAKgI,eAKzBM,cAAe,SAAUjD,GAEvBA,EAAImD,MAAMC,SAAW,EACrBpD,EAAImD,MAAME,SAAW,GAGvBnE,YAAa,SAAU+B,GACrB,GAAI9B,GAAMd,EAAEe,WAER+D,EAAQlC,EAAKkC,MAAQxI,KAAKgI,aAE1BW,EAAiB,SAASC,GAC5BJ,EAAML,YAAYS,EAAKP,UAGlBG,EAAMK,UAAYL,EAAMK,SAASC,SAChCN,EAAMK,SAAS,GAAGE,WAAYzC,EAAK0C,OACrCR,EAAMS,SAENT,EAAMU,WAIV1E,EAAIM,QAAQ8D,EAAKP,UAqBnB,OAjBkB,YAAd/B,EAAK6C,KACPhD,KAAKkC,SAASe,aAAaC,2BAA2B/C,GACnDgD,KAAK,SAASjB,GACbM,EAAgBN,KAEG,UAAd/B,EAAK6C,MAAqB7C,EAAKiD,QAKjB,UAAdjD,EAAK6C,MAAoB7C,EAAKiD,SACvCpD,KAAKkC,SAASe,aAAaI,sBAAsBlD,GAC9CgD,KAAK,SAASjB,GACbM,EAAgBN,KAPpBlC,KAAKkC,SAASe,aAAaK,0BAA0BnD,GAClDgD,KAAK,SAASjB,GACbM,EAAgBN,KASf7D,EAAIG,WAUbmD,mBAAoB,SAAS4B,GAWzB,OATIA,EAAazB,kBACbyB,EAAazB,mBACbyB,EAAazB,gBAAgBC,gBAE7BwB,EAAazB,gBAAgBC,cAC7BwB,EAAazB,gBAAgBC,gBAIzBwB,EAAa7B,cACjB,IAAK,sBACD6B,EAAazB,gBAAgBC,YAAYG,SAAWsB,KAAKC,SAASC,sBAClE,MACJ,KAAK,oBACDH,EAAazB,gBAAgBC,YAAYG,SAAWsB,KAAKC,SAASE,oBAClE,MACJ,KAAK,yBACDJ,EAAazB,gBAAgBC,YAAYG,SAAWsB,KAAKC,SAASE,oBAClE,MACJ,KAAK,uBACDJ,EAAazB,gBAAgBC,YAAYG,SAAWsB,KAAKC,SAASG,mBAClE,MACJ,KAAK,mBACDL,EAAazB,gBAAgBC,YAAYG,SAAWsB,KAAKC,SAASG,mBAClE,MACJ,SACIL,EAAazB,gBAAgBC,YAAYG,SAAWsB,KAAKC,SAASC,uBAE1E,MAAOH,IAGXtB,wBAAyB,SAAS4B,GAC9B,GAAI3B,EACJ,QAAQ2B,EAAab,MACjB,IAAK,SAEDd,EAAW,GAAIlC,MAAKkC,SAAS4B,eAAeD,EAC5C,MACJ,KAAK,cACD3B,EAAW,GAAIlC,MAAKkC,SAAS6B,oBAAoBF,GAGzD,MAAO3B,WAQZrI,KAAK2J,MAA6B,gBAAd3J,MAAK2J,OAC1B3J,KAAK2J,SAGTA,KAAKC,UAEHnD,QACE0D,KAAQ,mBACRC,KAAQ,mBACRC,KAAQ,mBACRC,KAAQ,kBACRC,kBACE1D,KAAQ,SAIZ2D,aACEC,iBACE5H,IAAO,iFAOXiH,sBACEX,KAAQ,SACRuB,MAAS,GACTC,YAAe,GACfC,QACEC,OAAU,GAAG,IAAI,IAAI,KACrBC,KAAQ,EACRC,MAAS,EACTC,QAAW,EACXC,QAAW,EACX9B,KAAQ,UACR+B,MAAS,gBACTC,SACEN,OAAU,IAAI,IAAI,IAAI,KACtBO,MAAS,GACTjC,KAAQ,UACR+B,MAAS,kBASfnB,qBACEZ,KAAQ,SACRyB,QACEC,OAAU,EAAE,IAAI,IAAI,KACpBO,MAAS,EACTjC,KAAQ,UACR+B,MAAS,iBAQbrB,wBACEV,KAAQ,SACRyB,QACEC,OAAU,GAAG,IAAI,IAAI,KACrBM,SACEN,OAAU,IAAI,IAAI,IAAI,KACtBO,MAAS,GACTjC,KAAQ,UACR+B,MAAS,gBAEX/B,KAAQ,UACR+B,MAAS,kBAKf,WAEE,YAEAjL,MAAKsD,OAAO,OAAQ,SAAU8H,EAAM5H,EAAKvD,EAAUC,GAEjDkL,EAAKC,WAAanL,EAAWoL,SAAS1H,QAEpC2H,SAAU,WACRxL,KAAKyL,iBAGPA,cAAe,WACb,GAEInF,IACFoF,WAAW,EACXC,UAAW,EACXC,MAAM,GAGJxJ,EAAaqB,EAAItB,eACrBC,GAAW0B,YAEX,IAAI+H,IACFC,KAAM,WACNC,WAAY,SAASC,GACnB,MAAOA,IAETC,WACEC,MAAO,IAETC,OAAQ/J,EAAWgK,YAGrBpM,MAAKqM,GAAGhL,OAAOiL,UAAUhG,EAAMuF,IAGjCU,oBAAqB,WAEnBvM,KAAKwM,MAAMC,KACT9K,EAAG3B,KAAKqM,GAAGhL,OAAOiL,UAAU,OAC5BI,KAAM,IAGR1M,KAAKqB,UAGPsL,YAAa,WACX,GAAIhL,GAAI3B,KAAKqM,GAAGhL,OAAOiL,UAAU,MACjCtM,MAAKwM,MAAMC,KACT9K,EAAGA,EACH+K,KAAM,KAIVE,UAAU,SAASC,GACD,KAAZA,EAAEC,QACJD,EAAEE,iBAEF/M,KAAKqM,GAAGhL,OAAOiL,UAAU,SAEzBtM,KAAK2M,cAEL3M,KAAKqB,WAIT2L,QAAS,WACPhN,KAAK2M,eAGPM,oBAAqB,WACnBjN,KAAK2M,cACL3M,KAAKqB,UAGPA,OAAQ,WACNoC,EAAIpC,iBAUZ,WAEE,YAEApB,MAAKsD,OAAO,SAAU,SAAUhD,EAAQkD,EAAKvD,EAAUC,EAAYuD,EAAG3B,GAEpExB,EAAOC,YAAcN,EAASgN,MAAMrJ,QAElC+F,UACEjI,EAAG,GACH+K,KAAM,EACNS,SAAU,GACVC,YAAa,EACbC,QAAS,aAGXC,mBAAqB,IAAK,OAAQ,WAAY,WAE9CC,eAAgB,WAEd,GAAI/K,GAAMT,EAAEyL,KAAKxN,KAAKyN,SAAUzN,KAAKsN,kBAErC,OAAO5J,GAAEgK,MAAMlL,IAGjBlB,SAAU,SAAUyB,GAIlB,GAAI5B,GAAQ,UAGZ,OAFAA,IAAS,EAAQ,SAAW,IAC5BA,GAASnB,KAAKuN,kBAIhBI,OAAQ,WACN,MAAOlK,GAAIX,OAAOC,IAAM/C,KAAKsB,UAAS,WAS9CrB,KAAK6C,QAKHC,IAAK,4BAEP/C,KAAK4N,KAAOC,6BAA8B,SAASrL,KACnDA,MAAQA,OACR,EAAA,GAAIsL,KAAKC,IAAM,EAAUhM,GAAEiM,OAC3B,KAAMxL,IACNuL,KAAO,+FACuB,OAA5BD,IAAM,eAA6B,GAAKA,KAC1C,YACqB,OAAnBA,IAAM,MAAoB,GAAKA,KACjC,qVACwB,OAAtBA,IAAM,SAAuB,GAAKA,KACpC,8EACwB,OAAtBA,IAAM,SAAuB,GAAKA,KACpC,sEACwB,OAAtBA,IAAM,SAAuB,GAAKA,KACpC,+GACuC,OAArCA,IAAM,wBAAsC,GAAKA,KACnD,2EACoB,OAAlBA,IAAM,KAAmB,GAAKA,KAChC,6MAC4B,OAA1BA,IAAM,aAA2B,GAAKA,KACxC,kKACsB,OAApBA,IAAM,OAAqB,GAAKA,KAClC,0DAC8C,OAA5CA,IAAQG,OAAOC,YAAYC,YAAwB,GAAKL,KAC1D,kEAC8C,OAA5CA,IAAQG,OAAOG,YAAYD,YAAwB,GAAKL,KAC1D,uDACiC,OAA/BA,IAAQO,KAAKC,KAAK,QAAoB,GAAKR,KAC7C,gEACsB,OAApBA,IAAM,OAAqB,GAAKA,KAClC,kRAGA,OAAOC,MAEPQ,+BAAgC,SAAS/L,KACzCA,MAAQA,OACR,EAAA,GAAIsL,KAAKC,IAAM,EAAUhM,GAAEiM,OAAcQ,MAAMC,UAAUH,KAEzD,KAAM9L,IAELT,EAAEC,KAAK0M,OAAQ,SAAU1F,GAC1B+E,KAAO,cACgC,OAArCD,IAAQ/E,WAAWC,EAAM8C,OAAmB,GAAKgC,KACnD,cAEAC,KAAO,MAGP,OAAOA,MAEPY,2BAA4B,SAASnM,KACrCA,MAAQA,OACR,EAAA,GAAIsL,KAAKC,IAAM,EAAUhM,GAAEiM,OAAcQ,MAAMC,UAAUH,KAEzD,KAAM9L,IACNuL,KAAO,gBAC+B,OAApCD,IAAQc,KAAKC,kBAA8B,GAAKf,KAClD,QACoC,OAAlCA,IAAQgB,GAAGD,kBAA8B,GAAKf,KAChD,QACuC,OAArCA,IAAQiB,MAAMF,kBAA8B,GAAKf,KACnD,yJACC/L,EAAEC,KAAK0M,OAAQ,SAAU1F,GAC1B+E,KAAO,iBAEPA,KADKiB,YAAchG,EAAM8C,KAClB,yCACoB,OAAzBgC,IAAQ9E,EAAW,MAAa,GAAK8E,KACvC,aAC0B,OAAxBA,IAAM,WAAyB,GAAKA,KACtC,wBAC0C,OAAxCA,IAAQ9E,EAAMiG,OAASjG,EAAM8C,MAAkB,GAAKgC,KACtD,mDAC8B,OAA5BA,IAAM,eAA6B,GAAKA,KAC1C,6EAEO,yCACoB,OAAzBA,IAAQ9E,EAAW,MAAa,GAAK8E,KACvC,wBAC0C,OAAxCA,IAAQ9E,EAAMiG,OAASjG,EAAM8C,MAAkB,GAAKgC,KACtD,sCAEAC,KAAO,iBAEPA,KAAO,+HACFmB,MAAMpG,OAAS,IACpBiF,KAAO,wCACmB,OAAxBD,IAAM,WAAyB,GAAKA,KACtC,oBACyB,OAAvBA,IAAM,UAAwB,GAAKA,KACrC,yEACC/L,EAAEC,KAAKkN,MAAO,SAAUxC,GACzBqB,KAAO,2BACqB,OAA1BD,IAAQpB,EAAY,QAAa,GAAKoB,KACxC,wCAC0B,OAAxBA,IAAQpB,EAAU,MAAa,GAAKoB,KACtC,MAC0B,OAAxBA,IAAQpB,EAAU,MAAa,GAAKoB,KACtC,wBAEAC,KAAO,4CACkB,OAAvBD,IAAM,UAAwB,GAAKA,KACrC,oBACyB,OAAvBA,IAAM,UAAwB,GAAKA,KACrC,8DAEAC,KAAO,uBAGP,OAAOA,MAEPoB,sBAAuB,SAAS3M,KAChCA,MAAQA,OACR,EAAA,GAASuL,KAAM,EAAUhM,GAAEiM,OAC3B,KAAMxL,IACNuL,KAAO,wHAGP,OAAOA,MAEPqB,sBAAuB,SAAS5M,KAChCA,MAAQA,OACR,EAAA,GAASuL,KAAM,EAAUhM,GAAEiM,OAC3B,KAAMxL,IACNuL,KAAO,6FAGP,OAAOA,MAEPsB,sBAAuB,SAAS7M,KAChCA,MAAQA,OACR,EAAA,GAASuL,KAAM,EAAUhM,GAAEiM,OAC3B,KAAMxL,IACNuL,KAAO,4vBAGP,OAAOA,MAEPuB,kCAAmC,SAAS9M,KAC5CA,MAAQA,OACR,EAAA,GAASuL,KAAM,EAAUhM,GAAEiM,OAC3B,KAAMxL,IACNuL,KAAO,8CAGP,OAAOA,MAEPwB,iCAAkC,SAAS/M,KAC3CA,MAAQA,OACR,EAAA,GAAIsL,KAAKC,IAAM,EAAUhM,GAAEiM,OAC3B,KAAMxL,IACNuL,KAAO,QACc,OAAnBD,IAAM,MAAoB,GAAKA,KACjC,iBACsB,OAApBA,IAAM,OAAqB,GAAKA,KAClC,iBAC6B,OAA3BA,IAAM,cAA4B,GAAKA,KACzC,iBAC0B,OAAxBA,IAAM,WAAyB,GAAKA,KACtC,iBACsB,OAApBA,IAAM,OAAqB,GAAKA,KAClC,iBAC6C,OAA3CA,IAAQG,OAAOC,YAAYsB,WAAuB,GAAK1B,KACzD,iBAC6C,OAA3CA,IAAQG,OAAOG,YAAYoB,WAAuB,GAAK1B,KACzD,OAGA,OAAOC,MAEP0B,oCAAqC,SAASjN,KAC9CA,MAAQA,OACR,EAAA,GAASuL,KAAM,EAAUhM,GAAEiM,OAC3B,KAAMxL,IACNuL,KAAO,qTAGP,OAAOA,MAEP2B,4BAA6B,SAASlN,KACtCA,MAAQA,OACR,EAAA,GAAIsL,KAAKC,IAAM,EAAUhM,GAAEiM,OAAcQ,MAAMC,UAAUH,KAEzD,KAAM9L,IACNuL,KAAO,aACD4B,sBACN5B,KAAO,iCACW,OAAhBD,IAAM,GAAiB,GAAKA,KAC9B,mBAC6C,OAA3CA,IAAQV,YAAYyB,kBAA8B,GAAKf,KACzD,mBAEAC,KAAO,idACFmB,MAAMpG,OAAS,IACpBiF,KAAO,wCACmB,OAAxBD,IAAM,WAAyB,GAAKA,KACtC,eACwB,OAAtBA,IAAM,SAAuB,GAAKA,KACpC,iBACyB,OAAvBA,IAAM,UAAwB,GAAKA,KACrC,yEACC/L,EAAEC,KAAKkN,MAAO,SAAUxC,GACzBqB,KAAO,2BACqB,OAA1BD,IAAQpB,EAAY,QAAa,GAAKoB,KACxC,eACyB,OAAvBA,IAAQpB,EAAS,KAAa,GAAKoB,KACrC,qCAC0B,OAAxBA,IAAQpB,EAAU,MAAa,GAAKoB,KACtC,MAC0B,OAAxBA,IAAQpB,EAAU,MAAa,GAAKoB,KACtC,wBAEAC,KAAO,4CACkB,OAAvBD,IAAM,UAAwB,GAAKA,KACrC,eACwB,OAAtBA,IAAM,SAAuB,GAAKA,KACpC,iBACyB,OAAvBA,IAAM,UAAwB,GAAKA,KACrC,8DAEAC,KAAO,uBAGP,OAAOA,OAGP,WAEE,YAEA9N,MAAKsD,OAAO,OAAQ,SAAU7C,GAE5BA,EAAKkP,iBAAmB3P,KAAKoL,KAAKC,WAAWzH,QAE3CC,WAAY,WACV9D,KAAK6P,SAAS7P,KAAKwM,MAAO,WAAYxM,KAAK8P,iBAG7CC,GAAI,2BAEJC,UAAU,EAEVC,QACEC,yBAA0B,YAC1BC,uBAAwB,UACxBC,2BAA4B,sBAC5BC,2BAA4B,uBAG9BhE,IACEhL,OAAQ,kBAGVyO,eAAgB,WACd9P,KAAKqM,GAAGhL,OAAOiL,UAAU,MAAOtM,KAAKwM,MAAMrF,IAAI,cAUvD,WAEE,YAEAlH,MAAKsD,OAAO,OAAQ,SAAU7C,EAAM+C,EAAKvD,EAAUC,EAAYuD,EAAG3B,GAEhErB,EAAKC,OAASR,EAAWmQ,WAAWzM,QAElCC,WAAY,WACV/B,EAAEgC,QAAQ/D,KAAM,cAChBA,KAAKuQ,iBAAmB,GAAI7P,GAAKkP,kBAAmBpD,MAAO/I,EAAInD,cAAekQ,UAGhFT,GAAI,OAEJU,SACEC,KAAM,gBAGRT,QACEU,mBAAoB,gBAGtBC,aAAc,SAAU/D,GACjBA,EAAEgE,SAAYhE,EAAEiE,UACnBjE,EAAEE,iBACFtJ,EAAIzC,SAAS,IAAMC,SAAS,MAIhCC,WAAY,WACV,GAAIuE,GAAOzF,IACgD,KAAvDE,EAASU,QAAQgB,cAAcmP,QAAQ,YACzCtL,EAAKuL,IAAIC,YAAY,aAErBxL,EAAKuL,IAAIE,SAAS,qBAW5B,WAEE,YAEAjR,MAAKsD,OAAO,aAAc,SAAU4N,EAAY1N,GAE9C0N,EAAWC,KAAOnR,KAAKoL,KAAKC,WAAWzH,QAErCC,WAAY,WACV9D,KAAKwM,MAAQ/I,EAAInD,aAGnB0P,SAAUpC,IAAI,uBAEdqC,QACEoB,kBAAmB,YACnBC,gBAAiB,UACjBC,oBAAqB,sBACrBlB,2BAA4B,uBAG9BhE,IACEhL,OAAQ,WAGVmQ,GAAI,OAEJC,aAAc,WACZzR,KAAKqM,GAAGhL,OAAOqQ,gBAUvB,WAEE,YAEAzR,MAAKsD,OAAO,aAAc,SAAU4N,EAAY1N,EAAKvD,EAAUC,GAE7DgR,EAAWQ,WAAaxR,EAAWwR,WAAW9N,QAE5C+N,OAAQ,WACN,GAAIC,GAAO,GAAIV,GAAWC,IAC1B3N,GAAIhD,OAAOqR,UAAU,QAAQC,KAAKF,WAU1C,WAEE,YAEA5R,MAAKsD,OAAO,aAAc,SAAU4N,EAAY1N,EAAKvD,GAGnDiR,EAAWa,OAAS9R,EAASC,WAAW8R,UAAUpO,QAChDqO,WACE,GAAI,UAKRf,EAAWgB,eAAe,WACX,GAAIhB,GAAWa,QAASI,WAAYjB,EAAWkB,QAI9DlB,EAAWkB,KAETN,KAAM,SAAS3Q,GAETpB,KAAKsS,iBACPtS,KAAKsS,eAAiB,GAAInB,GAAWQ,WAAWvQ,IAGlDpB,KAAKsS,eAAeV,OAAOxQ,UAOnC,WAEE,YAEAnB,MAAKsD,OAAO,SAAU,SAAUhD,EAAQkD,EAAKvD,EAAUC,EAAYuD,EAAG3B,GAEpExB,EAAOgS,aAAerS,EAASgN,MAAMrJ,QAEnC+F,UACE4H,GAAI,GACJ1F,KAAM,GACNnB,YAAa,GACb0D,QACAmE,uBAAwB,GACxBC,MAAO,GACP5P,IAAK,GACLqL,WAAY,GACZE,WAAY,GACZsE,MAAO,EACPC,cAAe,IAGjBC,MAAO,SAAUzP,GACf,MAAOA,GAASC,MAAQD,GAG1BN,IAAK,WACH,MAAO5C,MAAK6C,OAAOC,IAAM,YAAc/C,KAAKmH,IAAI,MAAQ,SAG1D0L,iBAAkB,WAChB,GAAInE,GAAS1O,KAAKmH,IAAI,SACtB,OAAOpF,GAAEmB,OAAOwL,EAAQ,SAAU1C,GAChC,MAAOjK,GAAE+Q,UAAW,sBAAuB,sBAAuB,wBAA0B9G,EAAK7C,gBAW3G,WAEE,YAEAlJ,MAAKsD,OAAO,SAAU,SAAUhD,EAAQkD,EAAKvD,EAAUC,EAAYuD,EAAG3B,GAEpExB,EAAOwS,kBAAoB7S,EAAS8S,WAAWnP,QAE7C2I,MAAOjM,EAAOgS,aAEd1P,IAAK,WACH,MAAOY,GAAInD,YAAYqN,QAAO,IAGhCiF,MAAO,SAAUK,GAGf,MADAxP,GAAInD,YAAYmM,IAAI1K,EAAE8B,OAAOoP,EAAKC,SAASC,iBAAkBF,EAAKC,SAASE,QACpEH,EAAK7P,aAUpB,WAEE,YAEAnD,MAAKsD,OAAO,gBAAiB,SAAU8P,EAAe5P,EAAKvD,EAAUC,EAAYuD,GAE/E2P,EAAc9H,SAAWpL,EAAWoL,SAAS1H,QAE3CmM,SAAUpC,IAAI,kCAEdpB,MAAOvM,KAAKM,OAAOgS,aAEnBe,QAAS,KAETrD,QACEsD,MAAO,WAGTC,QAAS,WACPxT,KAAKiB,QAAQ,iBAAkBjB,KAAKwM,UAKxC6G,EAAcI,YAActT,EAAWoL,SAAS1H,QAE9CmM,SAAUpC,IAAI,qCAEd0F,QAAS,KAETI,UAAW,YAIbL,EAAcM,UAAYxT,EAAWoL,SAAS1H,QAE5CmM,SAAUpC,IAAI,mCAEd0F,QAAS,OAIXD,EAAcjC,KAAOjR,EAAWyT,cAAc/P,QAE5CC,WAAY,WACV9D,KAAK6P,SAAS7P,KAAM,2BAA4BA,KAAK6T,gBAGvDlE,qBAAqB,EAErBK,SAAUpC,IAAI,6BAEdkG,UAAWT,EAAc9H,SAEzBwI,mBAAoB,QAEpBC,aAAc,WACZ,MAAIhU,MAAK2P,oBACA0D,EAAcI,YAEdJ,EAAcM,WAIzB1D,QACEgE,wBAAyB,iBAG3BC,aACEC,qBAAsB,UAGxBC,kBACEC,KAAQ,mBACRC,MAAS,oBAGX9C,GAAI,eAEJ+C,iBAAkB,WAChBvU,KAAK2P,qBAAsB,EAC3B3P,KAAKwQ,UAGPqD,cAAe,SAAUC,EAAWU,GAClC/Q,EAAIzC,SAAS,aAAewT,EAAWrN,IAAI,OAASlG,SAAS,KAG/DwT,cAAe,SAAU5H,GAEvB,IAAKA,EAAEgE,UAAWhE,EAAEiE,QAAS,CAC3BjE,EAAE6H,kBACF7H,EAAEE,gBACF,IAAIL,GAAOhJ,EAAEmJ,EAAE8H,QAAQC,QAAQ,KAAKxR,KAAK,OAIzCpD,MAAKwM,MAAMC,IAAI,OAAQC,GACvBjJ,EAAIpC,WAIRwT,gBAAiB,WAkBf,IAAK,GADDC,GAfAC,EAAOtR,EAAInD,YAAYmN,SAEvBuH,EAAMC,KAAKC,MAAMH,EAAK3H,aACtBV,GAAQqI,EAAKrI,KACbkC,EAAiB,IAATlC,EAAcA,EAAO,EAAIA,EACjC5B,EAAOiK,EAAK5H,SACZgI,EAAcF,KAAKG,KAAKJ,EAAMlK,GAC9BoE,KAGArO,EAAUsU,EAAc,IAAMvG,EAAO,EAAMA,EAAO,EAAI,EACtDyG,EAAQF,EAActU,EAAQ,EAAMA,EAAQ,EAAIsU,EAGhD7U,EAAcN,KAAKwM,MAAM8I,QAEpBC,EAAI1U,EAAYwU,GAALE,EAAUA,IAC5BT,EAAUS,IAAM3G,EAAQ,SAAW,GACnCtO,EAAYmM,IAAI,OAAQ8I,GACxBrG,EAAMsG,MAAO3S,IAAKvC,EAAYgB,UAAS,GAAQoL,KAAM6I,EAAGT,OAAQA,GAGlE,IAAIW,GAAUzV,KAAKwM,MAAMlL,UAAS,GAC9BoU,EAAWhJ,CACF,KAATkC,IACF8G,EAAWhJ,EAAK,EAChBpM,EAAYmM,IAAI,OAAQiJ,GACxBD,EAAUnV,EAAYqN,SAExB,IAAIgI,GAAU3V,KAAKwM,MAAMlL,UAAS,GAC9BsU,EAAWlJ,CAOf,OANIyI,KAAgBvG,IAClBgH,EAAWlJ,EAAO,EAClBpM,EAAYmM,IAAI,OAAQmJ,GACxBD,EAAUrV,EAAYqN,WAItBkI,UAAqB,IAATjH,EAAc,WAAa,GACvCkH,SAAWX,IAAgBvG,EAAQ,WAAa,GAChD6G,QAASA,EACTE,QAASA,EACTD,SAAUA,EACVE,SAAUA,EACV1G,MAAOA,EACPS,oBAAqB3P,KAAK2P,6BAWpC,WAEE,YAEA1P,MAAKsD,OAAO,gBAAiB,SAAU8P,EAAe5P,EAAKvD,EAAUC,GAEnEkT,EAAc1B,WAAaxR,EAAWwR,WAAW9N,QAE/C+N,OAAQ,WACN5R,KAAK+V,WAAa,GAAItS,GAAIlD,OAAOwS,kBACjC/S,KAAK+V,WAAWC,OAAQC,OAAO,IAC/BjW,KAAK6R,KAAO,GAAIwB,GAAcjC,MAAO5E,MAAO/I,EAAInD,YAAayV,WAAY/V,KAAK+V,aAC9EtS,EAAIhD,OAAOqR,UAAU,QAAQC,KAAK/R,KAAK6R,cAU/C,WAEE,YAEA5R,MAAKsD,OAAO,gBAAiB,SAAU8P,EAAe5P,EAAKvD,GAGzDmT,EAAcrB,OAAS9R,EAASC,WAAW8R,UAAUpO,QACnDqO,WACEgE,cAAe,UAKnB7C,EAAclB,eAAe,WACd,GAAIkB,GAAcrB,QAASI,WAAYiB,EAAchB,QAIpEgB,EAAchB,KAEZN,KAAM,SAAS3Q,GAEb,GAAI+U,GAAW1S,EAAIhC,qBAInBgC,GAAInD,YAAYmM,IAAI0J,GAEhBnW,KAAKoW,oBACPpW,KAAKoW,kBAAoB,GAAI/C,GAAc1B,WAAWvQ,IAGxDpB,KAAKoW,kBAAkBxE,OAAOxQ,UAQtC,WAEE,YAEAnB,MAAKsD,OAAO,SAAU,SAAUhD,EAAQkD,EAAKvD,GAE3CK,EAAO8V,WAAanW,EAASgN,MAAMrJ,gBAWvC,WAEE,YAEA5D,MAAKsD,OAAO,SAAU,SAAUhD,EAAQkD,EAAKvD,EAAUC,EAAYuD,EAAG3B,GAEpExB,EAAO+V,cAAgBpW,EAAS8S,WAAWnP,QAEzCC,WAAY,SAAUiF,EAAY3H,GAChCpB,KAAKiH,QAAU7F,EAAQ6F,OAEvB,IAAIsP,GAAoBvW,KAAKiH,QAAQE,IAAI,8BACzCnH,MAAKwW,mBAAqBD,GAAqBA,EAAkBE,oBAEjEzW,KAAK0W,QAAU1W,KAAKiH,QAAQE,IAAI,oBAGlCwP,QAAS,GAETjK,KAAM,EAENgK,QAAS,GAETE,YAAY,EAEZpK,MAAOjM,EAAO8V,WAEdQ,YAAa,WACX,GAAIhU,GAAM7C,KAAKiH,QAAQE,IAAI,MAC3BtE,IAAO,gYAEH7C,KAAKwW,qBACP3T,GAAO,iBAAmB7C,KAAK0M,KAAO1M,KAAK2W,QAC3C9T,GAAO,sBAAwB7C,KAAK2W,QAOtC,IAAID,GAAU1W,KAAK0W,OASnB,OARK1W,MAAK4W,aACRF,GAAW,SAKb7T,GAAO,kBAAoB6T,GAK7B7T,IAAK,WACH,MAAO7C,MAAK6W,eAGdjE,MAAO,SAAUK,GAGf,GAAI6D,GAAO7D,EAAK8D,QAQhB,OAPK/W,MAAKwW,qBAKRM,EAAO/U,EAAEiV,MAAMF,EAAM9W,KAAK2W,UAErBG,UAUf,WAEE,YAEA7W,MAAKsD,OAAO,iBAAkB,SAAU0T,EAAgBxT,EAAKvD,EAAUC,EAAYuD,GAEjFuT,EAAeC,aAAe/W,EAAWoL,SAAS1H,QAEhDC,WAAY,SAAU1C,GACpBpB,KAAKiH,QAAU7F,EAAQ6F,QACvBjH,KAAK0O,OAAS1O,KAAKiH,QAAQE,IAAI,WAGjC6I,SAAUpC,IAAI,gCAEdiH,gBAAiB,WACf,GAAIpP,GAAOzF,IACX,QACE0O,OAAQjJ,EAAKiJ,SAIjBlC,MAAOvM,KAAKM,OAAO8V,WAEnB/C,QAAS,OAIX2D,EAAeE,UAAYhX,EAAWyT,cAAc/P,QAElDC,WAAY,WACV9D,KAAK+V,WAAa,GAAItS,GAAIlD,OAAO+V,kBAAoBrP,QAASjH,KAAKwM,QACnExM,KAAK+V,WAAWC,SAGlB/F,QACEmH,2BAA4B,gBAC5BC,iBAAkB,QAGpBjD,kBAEEkD,MAAS,UAGXtH,SAAUpC,IAAI,4BAEdkG,UAAWmD,EAAeC,aAE1BK,iBAAkB,WAChB,GAAItQ,GAAUjH,KAAKwM,KACnB,QACEvF,QAASA,IAIb4N,gBAAiB,WAGf,GAAIrS,IACFqT,UAAW,GACXC,SAAU,GACVJ,SAAU,EACVE,SAAU,EACV1G,SACAsI,gBAAgB,EAChB5I,KAAM,EACNE,GAAI9O,KAAK+V,WAAWY,QACpB5H,MAAO/O,KAAKwM,MAAMrF,IAAI,gBACtB6H,UAAWhP,KAAK+V,WAAWW,QAC3Be,UAAWzX,KAAK+V,WAAWa,WAAa,WAAa,YACrDc,cAAe1X,KAAK+V,WAAWa,WAAa,uBAAyB,qBAGvE,IAAI5W,KAAK+V,WAAWS,mBAAoB,CAUtC,IAAK,GADD1B,GARA6C,EAAa1C,KAAKG,KAAKpV,KAAKwM,MAAMrF,IAAI,gBAAkBnH,KAAK+V,WAAWY,SAExEjK,EAAO1M,KAAK+V,WAAWrJ,KAGvB7L,EAAS8W,EAAa,IAAMjL,EAAO,EAAKA,EAAO,EAAI,EACnD2I,EAAOsC,EAAa9W,EAAQ,EAAKA,EAAQ,EAAI8W,EAErCzI,KACHqG,EAAI1U,EAAYwU,GAALE,EAAUA,IAC5BT,EAAUS,IAAM7I,EAAO,EAAK,SAAW,GACvCwC,EAAMsG,MAAO9I,KAAM6I,EAAGT,OAAQA,GAGhC,IAAI/F,GAAQ/O,KAAKwM,MAAMrF,IAAI,gBACvByH,EAAOlC,EAAO1M,KAAK+V,WAAWY,QAAU,EACxC7H,EAAKpC,EAAO1M,KAAK+V,WAAWY,QAAU3W,KAAK+V,WAAWY,OAC1D7H,GAAYC,GAAND,EAAeA,EAAKC,EAE1BvM,GACEqT,UAAqB,IAATnJ,EAAc,WAAa,GACvCoJ,SAAW6B,IAAejL,EAAO,EAAK,WAAa,GACnDgJ,SAAUhJ,EACVkJ,SAAUlJ,EAAO,EACjBwC,MAAOA,EACPsI,gBAAgB,EAChB5I,KAAMA,EACNE,GAAIA,EACJC,MAAOA,EACPC,UAAWhP,KAAK+V,WAAWW,QAC3Be,UAAWzX,KAAK+V,WAAWa,WAAa,WAAa,YACrDc,cAAe1X,KAAK+V,WAAWa,WAAa,yBAA2B,wBAI3E,MAAOpU,IAGTuR,mBAAoB,QAEpBU,cAAe,SAAU5H,GACvB,GAAI+K,GAASlU,EAAEmJ,EAAE8H,QAAQC,QAAQ,KAC7BiD,EAAKD,EAAOhD,QAAQ,KACxB,KAAKiD,EAAGC,SAAS,cAAgBD,EAAGC,SAAS,UAAW,CACtD,GAAIpL,GAAOkL,EAAOxU,KAAK,QAAU,CACjCpD,MAAK+V,WAAWrJ,KAAOA,EACvB1M,KAAK+V,WAAWC,OAAQsB,OAAO,MAInCS,KAAM,SAAUlL,GACd,GAAI6J,GAAUhT,EAAEmJ,EAAE8H,QAAQvR,KAAK,YAC3BsT,KAEA1W,KAAK+V,WAAWa,WADdF,IAAY1W,KAAK+V,WAAWW,SACA1W,KAAK+V,WAAWa,YAEjB,EAE/B5W,KAAK+V,WAAWrJ,KAAO,EACvB1M,KAAK+V,WAAWW,QAAUA,EAC1B1W,KAAK+V,WAAWC,OAAQsB,OAAO,aAWzC,WAEE,YAEArX,MAAKsD,OAAO,iBAAkB,SAAU0T,EAAgBxT,EAAKvD,EAAUC,EAAYuD,EAAG3B,GAEpFkV,EAAe7F,KAAOjR,EAAWoL,SAAS1H,QAExCC,WAAY,SAAU1C,GACpBW,EAAEgC,QAAQ/D,KAAM,kBAAmB,cACnCA,KAAKgY,WAAa5W,EAAQ4W,YAG5BhI,SAAUpC,IAAI,8BAEd4D,GAAI,eAEJnF,IACE7G,OAAU,OACVyS,eAAkB,oBAGpB/D,aACEgE,OAAU,UAGZrD,gBAAiB,WACf,GAAIsD,GAAUnY,KAAKwM,MAAM3J,MAAMrB,QAAQ,SAAU,GACjD,QACE2W,QAASA,IAIb3M,SAAU,WAERxL,KAAKoY,UAAY,GAAInB,GAAeE,WAAYpH,GAAI/P,KAAKqM,GAAG4L,eAAgBzL,MAAOxM,KAAKwM,QAASgE,UAOnGiB,aAAc,WACZ,GAAkD,UAA9CzR,KAAKwM,MAAMrF,IAAI,aAAakR,cAA2B,CACzD,GAAI5S,GAAOzF,IAEXA,MAAKqM,GAAG7G,OAAOuM,OACf/R,KAAKgY,WAAWtT,UAAU4T,KAAK,WAC7B7S,EAAKuS,WAAWzS,UAAU,OAASiB,OAAQf,EAAK+G,MAAMrF,IAAI,UAAUoR,cACpE9S,EAAKuS,WAAWjQ,WAAWtC,EAAK+G,WAOtCgM,UAAW,WACT,GAAIC,GAAWzY,KAAKwM,MAAMqG,kBAE1B,IAAI4F,EAAS3P,OAAO,CAIlB9I,KAAK0Y,UAAY1Y,KAAK0Y,WAAaD,EAAS,GAAG3M,IAG/C,IAAI4C,GAAS1O,KAAKwM,MAAMrF,IAAI,SAC5BnH,MAAKoT,MAAQpT,KAAK2Y,SAASjK,EAAQ1O,KAAK0Y,WACxC1Y,KAAKmJ,KAAOnJ,KAAK4Y,gBAAgB5Y,KAAKwM,MAAMrF,IAAI,iBAGhD,IAAI0R,IACFnK,OAAQ+J,EACRzP,MAAOhJ,KAAK0Y,UACZI,WAAY9Y,KAAKoT,MACjBjK,KAAMnJ,KAAKmJ,KACX4P,QAAS/Y,KAAKgZ,aAGXhZ,MAAKiZ,MAGRvV,EAAE,mBAAmBwV,SACrBlZ,KAAKiZ,KAAO,GAAIE,MAAK,QAASN,IAH9B7Y,KAAKiZ,KAAO,GAAIE,MAAK,QAASN,GAOhC7Y,KAAKiZ,KAAK5Y,GAAG,SAAUL,KAAKoZ,iBAC5BpZ,KAAKiZ,KAAK5Y,GAAG,cAAeL,KAAKqZ,YAEjCrZ,KAAKsZ,kBAKTX,SAAU,SAAUjK,EAAQgK,GAC1B,GAAIa,GAAWxX,EAAEyX,UAAU9K,GAAU5C,KAAM4M,GAC3C,OAAOa,GAAWA,EAAST,WAAa,MAG1CF,gBAAiB,SAAUa,GACzB,OAAQA,GACN,IAAK,oBACL,IAAK,yBACH,MAAO,OACT,KAAK,uBACH,MAAO,MACT,KAAK,sBACH,MAAO,SACT,SACE,MAAOA,GAASpB,gBAItBW,WAAY,WACV,GAAIU,GAAOC,EAAWlU,EAAOzF,IAC7B,QAAQA,KAAKmJ,MACX,IAAK,QACHuQ,EAAQ,UACRC,EAAY,MACZ,MACF,KAAK,UACHD,EAAQ,cACRC,EAAY,aAKhB,MAAOxT,MAAKyT,OAAOD,GAAWX,YAC5BU,MAAOA,EACP7T,QAAS,YACTgC,aAAcpC,EAAK0D,QAKvBiQ,gBAAiB,SAAUV,GAEzB,GAAIhK,GAAS1O,KAAKwM,MAAMrF,IAAI,SAC5BnH,MAAKoT,MAAQpT,KAAK2Y,SAASjK,EAAQgK,GACnC1Y,KAAK0Y,UAAYA,EAEjB1Y,KAAKsZ,cAActZ,KAAK6Z,iBAI1BR,WAAY,SAAUS,GACpB9Z,KAAK6Z,eAAiB7Z,KAAKgZ,aAAae,iBAAiBD,GACzD9Z,KAAKsZ,cAActZ,KAAK6Z,iBAI1BP,cAAe,SAAUU,GACvB,GAAIvU,GAAOzF,KAEPsG,GACF0C,MAAOhJ,KAAK0Y,UACZ7S,QAAS,YACTiT,WAAY9Y,KAAKoT,MACjBjK,KAAMnJ,KAAKmJ,KAGT6Q,KACF1T,EAAK0T,OAASA,EAGNvW,GAAIY,OAAO4V,QAAQ,qBAAsB3T,GAChDgS,KAAK,SAASjQ,GACK,UAAd5C,EAAK0D,MACP1D,EAAKwT,KAAKiB,iBAAiB7R,EAAS8R,WAK5CC,UAAW,WACTpa,KAAKgY,WAAW9S,UAChBlF,KAAKoY,UAAUlT,kBAUvB,WAEE,YAEAjF,MAAKsD,OAAO,iBAAkB,SAAU0T,EAAgBxT,EAAKvD,EAAUC,EAAYuD,EAAG3B,GAEpFkV,EAAetF,WAAaxR,EAAWwR,WAAW9N,QAEhDC,WAAY,WACV/B,EAAEgC,QAAQ/D,KAAM,mBAGlB4R,OAAQ,SAAUxQ,GAChBpB,KAAKgY,WAAa,GAAIvU,GAAID,MAAMG,WAChC3D,KAAKwM,MAAQ,GAAI/I,GAAIlD,OAAOgS,cAAef,GAAIpQ,IAC/CpB,KAAKwM,MACFwJ,QACEsC,KAAKtY,KAAKqa,gBACVC,KAAK,WACJ7W,EAAIlC,iBAIZ8Y,eAAgB,WACd,GAAIxI,GAAO,GAAIoF,GAAe7F,MAAO5E,MAAOxM,KAAKwM,MAAOwL,WAAYhY,KAAKgY,YACzEvU,GAAIhD,OAAOqR,UAAU,QAAQC,KAAKF,IAGpCxO,gBAAiB,WACXrD,KAAKgY,YACPhY,KAAKgY,WAAW9S,kBAW1B,WAEE,YAEAjF,MAAKsD,OAAO,iBAAkB,SAAU0T,EAAgBxT,EAAKvD,GAG3D+W,EAAejF,OAAS9R,EAASC,WAAW8R,UAAUpO,QACpDqO,WACEqI,kBAAmB,UAKvBtD,EAAe9E,eAAe,WACf,GAAI8E,GAAejF,QAASI,WAAY6E,EAAe5E,QAItE4E,EAAe5E,KAEbN,KAAM,SAAS3Q,GAETpB,KAAKwa,qBACPxa,KAAKwa,mBAAqB,GAAIvD,GAAetF,WAAWvQ,IAG1DpB,KAAKwa,mBAAmB5I,OAAOxQ,UAOvC,WAEE,YAEAnB,MAAKsD,OAAO,cAAe,SAAUkX,EAAahX,EAAKvD,EAAUC,GAE/Dsa,EAAYrJ,KAAOjR,EAAWoL,SAAS1H,QAErC2N,GAAI,aAEJkJ,YAAa,WACX,GACI1K,GADA2K,EAAY3a,KAAKwM,MAAMrF,IAAI,YAG/B,QAAQwT,GACN,IAAK,KACD3K,EAAWpC,IAAI,sBACjB,MACF,SACIoC,EAAWpC,IAAI,uBAGrB,MAAOoC,WAUf,WAEE,YAEA/P,MAAKsD,OAAO,cAAe,SAAUkX,EAAahX,EAAKvD,EAAUC,GAE/Dsa,EAAY9I,WAAaxR,EAAWwR,WAAW9N,QAE7C+N,OAAQ,SAAUxQ,GAEhB,GAAIoL,GAAQ,GAAItM,GAASgN,OAAQyN,UAAWvZ,EAAQuZ,YAChD9I,EAAO,GAAI4I,GAAYrJ,MAAO5E,MAAOA,GAEzC/I,GAAIhD,OAAOqR,UAAU,QAAQC,KAAKF,WAU1C,WAEE,YAEA5R,MAAKsD,OAAO,cAAe,SAAUkX,EAAahX,EAAKvD,GAGrDua,EAAYzI,OAAS9R,EAASC,WAAW8R,UAAUpO,QACjDqO,WACE0I,IAAO,WACPC,IAAO,cAKXJ,EAAYtI,eAAe,WACZ,GAAIsI,GAAYzI,QAASI,WAAYqI,EAAYpI,QAIhEoI,EAAYpI,KAEVyI,eAAgB,WACV9a,KAAK+a,kBACP/a,KAAK+a,gBAAkB,GAAIN,GAAY9I,aAI3CqJ,SAAU,WACRhb,KAAK8a,iBACL9a,KAAK+a,gBAAgBnJ,QAAS+I,UAAW,OAG3CM,SAAU,WACRjb,KAAK8a,iBACL9a,KAAK+a,gBAAgBnJ,QAAS+I,UAAW,aAOjDjX,EAAE,WACA,YAEAzD,MAAKY","file":"scripts/main.js","sourcesContent":["/*jshint -W020 */\r\n\r\nif (!this.MyOD || typeof this.MyOD !== 'object') {\r\n  this.MyOD = {};\r\n}\r\n\r\n(function () {\r\n  'use strict';\r\n\r\n  MyOD = new Backbone.Marionette.Application();\r\n\r\n  MyOD.on('before:start', function(options){\r\n    this.searchModel = new MyOD.Models.SearchModel();\r\n    this.layout = new MyOD.Main.Layout();\r\n    //this.reqres = new Backbone.Wreqr.RequestResponse();\r\n  });\r\n\r\n  MyOD.on('start', function(options){\r\n    if (Backbone.history){\r\n      //if you are hosting on a server that can let the browser handle all the routing,\r\n      //you can use pushstate, otherwise (gh-pages) use hashed urls\r\n      //Backbone.history.start({ pushState: Modernizr.history, root: '/OpenData-Backbone' });\r\n      if (!Backbone.history.start({ pushState: false, root: '/OpenData-Backbone' })) {\r\n        MyOD.navigate('404', { trigger:true });\r\n      }\r\n    }\r\n\r\n    Backbone.history.on('route', this.layout.setClasses);\r\n    this.layout.setClasses();\r\n  });\r\n\r\n  MyOD.navigate = function (route, options) {\r\n    Backbone.history.navigate(route, options);\r\n  };\r\n\r\n  MyOD.search = function (options) {\r\n    var route = MyOD.searchModel.getRoute();\r\n    MyOD.navigate(route, { trigger:true });\r\n  };\r\n\r\n  MyOD.navigate404 = function () {\r\n    MyOD.navigate('404', { trigger: true, replace: true });\r\n  };\r\n\r\n  MyOD.queryStringToObject = function () {\r\n    var result = {};\r\n\r\n    var q = Backbone.history.getFragment().split('?')[1];\r\n\r\n    if (q) {\r\n      var pairs = q.split('&');\r\n      \r\n      _.each(pairs, function(pair) {\r\n        pair = pair.split('=');\r\n        if (pair[0] === 'q') {\r\n          result[pair[0]] = pair[1].replace(/\\+/g, ' ') || '';\r\n        } else {\r\n          result[pair[0]] = decodeURIComponent(pair[1] || '');\r\n        }\r\n      });\r\n    }\r\n\r\n    return result;\r\n  };\r\n\r\n  MyOD.getBloodhound = function () {\r\n    if (!this.bloodhound) {\r\n      this.bloodhound = new Bloodhound({\r\n        datumTokenizer: Bloodhound.tokenizers.obj.whitespace('value'),\r\n        queryTokenizer: Bloodhound.tokenizers.whitespace,\r\n        limit: 10,\r\n        remote: {\r\n          url: MyOD.config.api + 'datasets/autocomplete.json?query=%QUERY',\r\n          rateLimitWait: 150,\r\n          replace: function (url, query) {\r\n            return url.replace('%QUERY', query);\r\n          },\r\n          filter: function(response) {\r\n            return response ? response.data : [];\r\n          }\r\n        }\r\n      });\r\n    }\r\n    return this.bloodhound;\r\n  };\r\n\r\n  MyOD.onBeforeDestroy = function () {\r\n    Backbone.history.stop();\r\n  };\r\n\r\n})();\r\n\n(function () {\r\n    \r\n  'use strict';\r\n\r\n  MyOD.module('Utils', function (Utils, App, Backbone, Marionette, $, _) {\r\n\r\n    Utils.MapManager = Marionette.Object.extend({\r\n      \r\n      initialize: function () {\r\n        _.bindAll(this, 'updateStyle');\r\n\r\n        this.globalChannel = Backbone.Wreqr.radio.channel('global');\r\n        //load dojo and start the map\r\n        this._loadDojo();\r\n        App.reqres.setHandler('smaps:update:style', this.updateStyle);\r\n\r\n      },\r\n\r\n      /**\r\n       * load dojo, resolve a promise when it's ready to roll\r\n       */\r\n      _loadDojo: function(){\r\n        var dfd = $.Deferred();\r\n        this.dojoReady = dfd.promise();\r\n        //check if dojo is loaded...\r\n        if( !window.dojo ){\r\n          //if not, inject a script tag, and then require in things\r\n          include('//js.arcgis.com/3.13compact/init.js', function(){\r\n            //now that require is present, load in the other things we need\r\n            require(['esri/map', 'esri/layers/FeatureLayer', 'plugins/smartMapping', 'dojo/domReady!'], function(Map) {\r\n              dfd.resolve();\r\n            });\r\n          }); \r\n\r\n        }else{\r\n          //it's loaded\r\n          dfd.resolve();\r\n        }\r\n      },\r\n\r\n\r\n      onBeforeDestroy: function () {\r\n        if (this.map) {\r\n          this.map.destroy();\r\n        }\r\n      },\r\n\r\n      proxyEvent: function (evtName, evt) {\r\n        this.globalChannel.vent.trigger(evtName, evt);\r\n        //OR (if everything that will listen has a reference to this)\r\n        //this.trigger(evtName, evt);\r\n      },\r\n\r\n      createMap: function (mapDiv, options) {\r\n        var self = this;\r\n        var mapOpts = {\r\n          center: [ -56.049, 38.485 ],\r\n          zoom: 3,\r\n          basemap: 'dark-gray',\r\n          smartNavigation:false,\r\n          navigationMode: 'css-transforms',\r\n          fitExtent:true,\r\n          minZoom: 2,\r\n          wrapAround180:true\r\n        };\r\n\r\n        this.map = new esri.Map(mapDiv, mapOpts);\r\n        \r\n       \r\n        var onLoad = function(opts){\r\n            opts.map.disableScrollWheelZoom();\r\n            if (options.coords) {\r\n              var extent = new esri.geometry.Extent(options.coords[0][0], options.coords[0][1], options.coords[1][0], options.coords[1][1], new esri.SpatialReference({ wkid: 4326 }));\r\n              opts.map.setExtent(extent);\r\n            }\r\n            self.proxyEvent('map:load');\r\n        };\r\n\r\n        //proxy events\r\n        this.map.on('load', dojo.hitch(this, onLoad));\r\n        this.map.on('extent-change', dojo.hitch(this, this.proxyEvent, 'map:extent-change'));\r\n        this.map.on('layer-add', dojo.hitch(this, this.proxyEvent, 'map:layer-add'));\r\n      },\r\n\r\n\r\n\r\n\r\n      getDatasetInfoTemplate: function (dataset) {\r\n        //var datasetName = dataset.get('name');\r\n        var displayFieldName = dataset.get('display_field');\r\n        var title = displayFieldName ? '${' + displayFieldName + '}' : 'Attributes';\r\n        return new esri.InfoTemplate(title, '${*}');\r\n      },\r\n\r\n      getDatasetLayerOpts: function (dataset) {\r\n        var opts = \r\n         { \r\n          mode: esri.layers.FeatureLayer.MODE_AUTO,\r\n          outFields: '*',\r\n          infoTemplate: this.getDatasetInfoTemplate(dataset),\r\n          geometryType: dataset.get('geometry_type')\r\n        };\r\n        //add the default symbol\r\n        this._addDefaultSymbols(opts);\r\n        return opts;\r\n      },\r\n\r\n      addDataset: function (dataset) {\r\n        var opts = this.getDatasetLayerOpts(dataset);\r\n        this.datasetLayer = new esri.layers.FeatureLayer(dataset.get('url'), opts);\r\n        //apply default renderer\r\n        if(opts.layerDefinition && opts.layerDefinition.drawingInfo){\r\n          //apply renderers\r\n          this.datasetLayer.setRenderer(this._createRendererFromJson(opts.layerDefinition.drawingInfo.renderer));\r\n        }\r\n\r\n        this.datasetLayer.on('load', this.onLoadDataset);\r\n\r\n        //proxy events\r\n        this.datasetLayer.on('load', dojo.hitch(this, this.proxyEvent, 'map:datasetlayer:load'));\r\n        this.datasetLayer.on('click', dojo.hitch(this, this.proxyEvent, 'map:datasetlayer:click'));\r\n        this.datasetLayer.on('query-limit-exceeded', dojo.hitch(this, this.proxyEvent, 'map:datasetlayer:query-limit-exceeded'));\r\n        this.datasetLayer.on('update-end', dojo.hitch(this, this.proxyEvent, 'map:datasetlayer:update-end'));\r\n\r\n        this.map.addLayer(this.datasetLayer);\r\n\r\n\r\n      },\r\n\r\n      onLoadDataset: function (evt) {\r\n        //squash scale ranges - we need the layer to draw at all scales\r\n        evt.layer.minScale = 0; \r\n        evt.layer.maxScale = 0;\r\n      },\r\n\r\n      updateStyle: function (opts) {\r\n        var dfd = $.Deferred();\r\n\r\n        var layer = opts.layer = this.datasetLayer;\r\n\r\n        var _applyRenderer = function(smap){\r\n          layer.setRenderer(smap.renderer);\r\n\r\n          //check if refresh needed, else redraw\r\n          if ( layer.graphics && layer.graphics.length ) {\r\n            if (layer.graphics[0].attributes[ opts.field ]) {\r\n              layer.redraw();\r\n            } else {\r\n              layer.refresh();\r\n            }\r\n          }\r\n\r\n          dfd.resolve(smap.renderer);\r\n        };\r\n\r\n          \r\n        if (opts.type === 'polygon'){\r\n          esri.renderer.smartMapping.createClassedColorRenderer(opts)\r\n            .then(function(renderer){\r\n              _applyRenderer( renderer );\r\n            });\r\n        } else if (opts.type === 'point' && !opts.heatmap){\r\n          esri.renderer.smartMapping.createClassedSizeRenderer(opts)\r\n            .then(function(renderer){\r\n              _applyRenderer( renderer );\r\n            });\r\n        } else if (opts.type === 'point' && opts.heatmap) {\r\n          esri.renderer.smartMapping.createHeatmapRenderer(opts)\r\n            .then(function(renderer){\r\n              _applyRenderer( renderer );\r\n            });\r\n        }\r\n\r\n        return dfd.promise();\r\n      },\r\n\r\n      /**\r\n       * Append in default layer styling by adding/updateing \r\n       * layerOptions.layerDefinition.drawingInfo and setting it's properties\r\n       * as though it was set from webmap.\r\n       * @param {Object} layerOptions Json hash of layer properties. Either from a webmap\r\n       * or constructed for a layer in a feature service\r\n       */\r\n      _addDefaultSymbols: function(layerOptions){\r\n          //add the layerDefinition node\r\n          if(!layerOptions.layerDefinition){\r\n              layerOptions.layerDefinition = {};\r\n              layerOptions.layerDefinition.drawingInfo = {};\r\n          }\r\n          if(!layerOptions.layerDefinition.drawingInfo){\r\n              layerOptions.layerDefinition.drawingInfo = {};\r\n          }\r\n\r\n          //depending on the type, load in the default renderer as json\r\n          switch (layerOptions.geometryType){\r\n              case 'esriGeometryPolygon':\r\n                  layerOptions.layerDefinition.drawingInfo.renderer = util.defaults.defaultPolygonRenderer;\r\n                  break;\r\n              case 'esriGeometryPoint':\r\n                  layerOptions.layerDefinition.drawingInfo.renderer = util.defaults.defaultPointRenderer;\r\n                  break;\r\n              case 'esriGeometryMultipoint':\r\n                  layerOptions.layerDefinition.drawingInfo.renderer = util.defaults.defaultPointRenderer;\r\n                  break;\r\n              case 'esriGeometryPolyline':\r\n                  layerOptions.layerDefinition.drawingInfo.renderer = util.defaults.defaultLineRenderer;\r\n                  break;\r\n              case 'esriGeometryLine':\r\n                  layerOptions.layerDefinition.drawingInfo.renderer = util.defaults.defaultLineRenderer;\r\n                  break;\r\n              default: \r\n                  layerOptions.layerDefinition.drawingInfo.renderer = util.defaults.defaultPolygonRenderer;\r\n          }\r\n          return layerOptions;\r\n      },\r\n\r\n      _createRendererFromJson: function(rendererJson){\r\n          var renderer;\r\n          switch (rendererJson.type){\r\n              case 'simple':\r\n                  //create the default symbol\r\n                  renderer = new esri.renderer.SimpleRenderer(rendererJson);\r\n                  break;\r\n              case 'classBreaks':\r\n                  renderer = new esri.renderer.ClassBreaksRenderer(rendererJson);\r\n                  break;\r\n          }\r\n          return renderer;\r\n      }\r\n\r\n      \r\n    });\r\n\r\n  });\r\n})();\nif (!this.util || typeof this.util !== 'object') {\r\n    this.util = {};\r\n}\r\n\r\nutil.defaults = {\r\n\r\n  extent:  {\r\n    'xmin': -24140227.55632808,\r\n    'ymin': 2529400.5847910205,\r\n    'xmax': 13430100.586391762,\r\n    'ymax': 8399764.357090997,\r\n    'spatialReference': {\r\n      'wkid': 102100\r\n    }\r\n  },\r\n\r\n  serviceUrls: {\r\n    'geometryService': { \r\n      'url': 'http://utility.arcgisonline.com/arcgis/rest/services/Geometry/GeometryServer' \r\n    }\r\n  },\r\n  /**\r\n   * Default Point Renderer for Composer\r\n   * @return {Object} Json Renderer\r\n   */   \r\n  defaultPointRenderer : {\r\n    'type': 'simple',\r\n    'label': '',\r\n    'description': '',\r\n    'symbol': {\r\n      'color': [49,130,189,225],\r\n      'size': 6,\r\n      'angle': 0,\r\n      'xoffset': 0,\r\n      'yoffset': 0,\r\n      'type': 'esriSMS',\r\n      'style': 'esriSMSCircle',\r\n      'outline': {\r\n        'color': [220,220,220,255],\r\n        'width': 0.6,\r\n        'type': 'esriSLS',\r\n        'style': 'esriSLSSolid'\r\n      }\r\n    }\r\n  },\r\n\r\n  /**\r\n   * Default Line Renderer for Composer\r\n   * @return {Object} Json Renderer\r\n   */\r\n  defaultLineRenderer :  {\r\n    'type': 'simple',\r\n    'symbol': {\r\n      'color': [0,122,194,255],\r\n      'width': 2,\r\n      'type': 'esriSLS',\r\n      'style': 'esriSLSSolid'\r\n    }\r\n  },\r\n\r\n  /**\r\n   * Default Polygon Renderer for Composer\r\n   * @return {Object} Json Renderer\r\n   */\r\n  defaultPolygonRenderer :{\r\n    'type': 'simple',\r\n    'symbol': {\r\n      'color': [49,130,189,225],\r\n      'outline': {\r\n        'color': [220,220,220,255],\r\n        'width': 0.6,\r\n        'type': 'esriSLS',\r\n        'style': 'esriSLSSolid'\r\n      },\r\n      'type': 'esriSFS',\r\n      'style': 'esriSFSSolid'\r\n    }\r\n  }\r\n};\n\r\n(function () {\r\n\r\n  'use strict';\r\n    \r\n  MyOD.module('Base', function (Base, App, Backbone, Marionette, $, _) {\r\n\r\n    Base.SearchView = Marionette.ItemView.extend({ \r\n\r\n      onRender: function(){\r\n        this.initTypeahead();\r\n      },\r\n\r\n      initTypeahead: function () {\r\n        var self = this;\r\n\r\n        var opts = {\r\n          highlight: true,\r\n          minLength: 3,\r\n          hint: false\r\n        };\r\n\r\n        var bloodhound = App.getBloodhound();\r\n        bloodhound.initialize();\r\n\r\n        var datasets = {\r\n          name: 'datasets',\r\n          displayKey: function(item) {\r\n            return item;\r\n          },\r\n          templates: {\r\n            empty: ''\r\n          },\r\n          source: bloodhound.ttAdapter()\r\n        };\r\n\r\n        this.ui.search.typeahead(opts, datasets);\r\n      },\r\n\r\n      onTypeaheadSelected: function (e) {\r\n        //clicking a selection with the mouse should initiate a search  \r\n        this.model.set({\r\n          q: this.ui.search.typeahead('val'),\r\n          page: 1\r\n        });\r\n\r\n        this.search();\r\n      },\r\n\r\n      updateModel: function () {\r\n        var q = this.ui.search.typeahead('val');\r\n        this.model.set({\r\n          q: q,\r\n          page: 1\r\n        });\r\n      },\r\n\r\n      onKeyDown:function(e){\r\n        if (e.which === 13) {\r\n          e.preventDefault();\r\n\r\n          this.ui.search.typeahead('close');\r\n\r\n          this.updateModel();\r\n\r\n          this.search();\r\n        }\r\n      },\r\n\r\n      onKeyUp: function () {\r\n        this.updateModel();\r\n      },\r\n\r\n      onSearchButtonClick: function () {\r\n        this.updateModel();\r\n        this.search();\r\n      },\r\n\r\n      search: function () {\r\n        App.search();\r\n      }\r\n\r\n    });\r\n\r\n  });\r\n\r\n})();\r\n\n\r\n(function () {\r\n\r\n  'use strict';\r\n    \r\n  MyOD.module('Models', function (Models, App, Backbone, Marionette, $, _) {\r\n          \r\n    Models.SearchModel = Backbone.Model.extend({ \r\n\r\n      defaults: {\r\n        q: '',\r\n        page: 1,\r\n        per_page: 20,\r\n        total_count: 0,\r\n        sort_by: 'relevance'\r\n      },\r\n\r\n      queryStringParams: [ 'q', 'page', 'per_page', 'sort_by' ],\r\n\r\n      getQueryString: function () {\r\n        //create an object containing only the attributes we need to generate the querystring\r\n        var obj = _.pick(this.toJSON(), this.queryStringParams);\r\n        //generate querystring parameters from the object\r\n        return $.param(obj);\r\n      },\r\n\r\n      getRoute: function (api) {\r\n        // we use this function to generate routes within the app\r\n        // AND to generate api urls - hence the api parameter\r\n        \r\n        var route = 'datasets';\r\n        route += (api) ? '.json?' : '?';\r\n        route += this.getQueryString();\r\n        return route;\r\n      },\r\n\r\n      getUrl: function () {\r\n        return App.config.api + this.getRoute(true);\r\n      }\r\n\r\n    });\r\n\r\n  });\r\n\r\n})();\r\n\nMyOD.config = {\r\n  //api: '//umb.dcdev.opendata.arcgis.com/'\r\n  //api: '//data3.dc.opendataqa.arcgis.com/'\r\n  //api: '//umb.dcdev.staging.datacommunity.io/'\r\n  //api: '//clt.charlotte.opendata.arcgis.com/'\r\n  api: '//opendataqa.arcgis.com/'\r\n};\nthis.JST = {\"datasets/templates/dataset\": function(obj) {\nobj || (obj = {});\nvar __t, __p = '', __e = _.escape;\nwith (obj) {\n__p += '<div class=\"clearfix\">\\r\\n  <h2 class=\"pull-left clearfix\"><img class=\"img-thumbnail\" src=\"' +\n((__t = ( thumbnail_url )) == null ? '' : __t) +\n'\"><span>' +\n((__t = ( name )) == null ? '' : __t) +\n'</span></h2>\\r\\n  <div class=\"dropdown pull-right\">\\r\\n    <button class=\"btn btn-primary\" type=\"button\" data-toggle=\"dropdown\" aria-haspopup=\"true\" aria-expanded=\"false\">\\r\\n      Download\\r\\n      <span class=\"caret\"></span>\\r\\n    </button>\\r\\n    <ul class=\"dropdown-menu\" role=\"menu\" aria-labelledby=\"dLabel\">\\r\\n      <li><a href=\"' +\n((__t = ( baseUrl )) == null ? '' : __t) +\n'.csv\" target=\"_blank\" download>Spreadsheet</a></li>\\r\\n      <li><a href=\"' +\n((__t = ( baseUrl )) == null ? '' : __t) +\n'.kml\" target=\"_blank\" download>KML</a></li>\\r\\n      <li><a href=\"' +\n((__t = ( baseUrl )) == null ? '' : __t) +\n'.zip\" target=\"_blank\" download>Shapefile</a></li>\\r\\n      <li class=\"divider\"></li>\\r\\n      <li><a href=\"' +\n((__t = ( arcgis_online_item_url )) == null ? '' : __t) +\n'\" target=\"_blank\">View in ArcGIS Online</a></li>\\r\\n      <li><a href=\"' +\n((__t = ( url )) == null ? '' : __t) +\n'\" target=\"_blank\">API</a></li>\\r\\n    </ul>\\r\\n  </div>\\r\\n</div>\\r\\n\\r\\n<div class=\"container\">\\r\\n  <div class=\"row\">\\r\\n    <div class=\"col-lg-6 col-md-6\">\\r\\n      <h4>Description</h4>\\r\\n      <p>' +\n((__t = ( description )) == null ? '' : __t) +\n'</p>\\r\\n      \\r\\n    </div>\\r\\n    <div class=\"col-lg-6 col-md-6\">\\r\\n      <dl class=\"dl-horizontal\">\\r\\n        \\r\\n        <dt>Owner:</dt>\\r\\n        <dd>' +\n((__t = ( owner )) == null ? '' : __t) +\n'</dd>\\r\\n\\r\\n        <dt>Created:</dt>\\r\\n        <dd>' +\n((__t = ( moment(created_at).calendar() )) == null ? '' : __t) +\n'</dd>\\r\\n        \\r\\n        <dt>Updated:</dt>\\r\\n        <dd>' +\n((__t = ( moment(updated_at).calendar() )) == null ? '' : __t) +\n'</dd>\\r\\n\\r\\n        <dt>Tags:</dt>\\r\\n        <dd>' +\n((__t = ( tags.join(' | ') )) == null ? '' : __t) +\n'</dd>\\r\\n        \\r\\n        <dt>Views:</dt>\\r\\n        <dd>' +\n((__t = ( views )) == null ? '' : __t) +\n'</dd>\\r\\n\\r\\n      </dl>\\r\\n    </div>\\r\\n\\r\\n\\r\\n  </div>\\r\\n</div>\\r\\n\\r\\n\\r\\n<div class=\"container\">\\r\\n  <div id=\"map\"></div>\\r\\n  <div id=\"smaps\">\\r\\n    <div class=\"container\"></div>\\r\\n  </div>\\r\\n</div>\\r\\n\\r\\n<div id=\"table-container\" class=\"container\"></div>\\r\\n';\n\n}\nreturn __p\n},\n\"datasets/templates/table-row\": function(obj) {\nobj || (obj = {});\nvar __t, __p = '', __e = _.escape, __j = Array.prototype.join;\nfunction print() { __p += __j.call(arguments, '') }\nwith (obj) {\n\n _.each(fields, function (field) { ;\n__p += '\\r\\n  <td>' +\n((__t = ( attributes[field.name] )) == null ? '' : __t) +\n'</td>\\r\\n';\n }); ;\n__p += '\\r\\n';\n\n}\nreturn __p\n},\n\"datasets/templates/table\": function(obj) {\nobj || (obj = {});\nvar __t, __p = '', __e = _.escape, __j = Array.prototype.join;\nfunction print() { __p += __j.call(arguments, '') }\nwith (obj) {\n__p += '<h4>Showing ' +\n((__t = ( from.toLocaleString() )) == null ? '' : __t) +\n' to ' +\n((__t = ( to.toLocaleString() )) == null ? '' : __t) +\n' of ' +\n((__t = ( total.toLocaleString() )) == null ? '' : __t) +\n'</h4>\\r\\n<div class=\"table-responsive\">  \\r\\n  <table class=\"table table-striped table-bordered table-hover\">\\r\\n    <thead>\\r\\n      <tr>\\r\\n        ';\n _.each(fields, function (field) { ;\n__p += '\\r\\n          ';\n if (sortField === field.name) { ;\n__p += '\\r\\n            <th data-field-name=\"' +\n((__t = ( field.name )) == null ? '' : __t) +\n'\" class=\"' +\n((__t = ( sortClass )) == null ? '' : __t) +\n'\">\\r\\n              ' +\n((__t = ( field.alias || field.name )) == null ? '' : __t) +\n'\\r\\n              <span class=\"glyphicon small ' +\n((__t = ( sortIconClass )) == null ? '' : __t) +\n' text-muted\" aria-hidden=\"true\"></span>\\r\\n            </th>\\r\\n          ';\n } else { ;\n__p += '\\r\\n            <th data-field-name=\"' +\n((__t = ( field.name )) == null ? '' : __t) +\n'\">\\r\\n              ' +\n((__t = ( field.alias || field.name )) == null ? '' : __t) +\n'\\r\\n            </th>\\r\\n          ';\n } ;\n__p += '\\r\\n        ';\n }); ;\n__p += '\\r\\n      </tr>\\r\\n    </thead>\\r\\n    <tbody></tbody>\\r\\n  </table>\\r\\n</div>\\r\\n<nav>\\r\\n  <ul class=\"pagination\">\\r\\n    ';\n if (pages.length > 1) { ;\n__p += '\\r\\n      <li id=\"page-prev\" class=\"' +\n((__t = ( firstPage )) == null ? '' : __t) +\n'\"><a data-page=\"' +\n((__t = ( prevPage )) == null ? '' : __t) +\n'\"><span aria-hidden=\"true\">&laquo;</span></a></li>\\r\\n      \\r\\n      ';\n _.each(pages, function (page) { ;\n__p += '\\r\\n        <li class=\"' +\n((__t = ( page.active )) == null ? '' : __t) +\n'\"><a class=\"page-number\" data-page=\"' +\n((__t = ( page.page )) == null ? '' : __t) +\n'\">' +\n((__t = ( page.page )) == null ? '' : __t) +\n'</a></li>\\r\\n      ';\n }); ;\n__p += '\\r\\n\\r\\n      <li id=\"page-next\" class=\"' +\n((__t = ( lastPage )) == null ? '' : __t) +\n'\"><a data-page=\"' +\n((__t = ( nextPage )) == null ? '' : __t) +\n'\"><span aria-hidden=\"true\">&raquo;</span></a></li>\\r\\n    ';\n } ;\n__p += '\\r\\n  </ul>\\r\\n</nav>';\n\n}\nreturn __p\n},\n\"error/templates/404\": function(obj) {\nobj || (obj = {});\nvar __t, __p = '', __e = _.escape;\nwith (obj) {\n__p += '<div class=\"alert alert-danger\" role=\"alert\">\\r\\n  <h2>The page you are looking for doesn\\'t exist.</h2>\\r\\n</div>\\r\\n';\n\n}\nreturn __p\n},\n\"error/templates/500\": function(obj) {\nobj || (obj = {});\nvar __t, __p = '', __e = _.escape;\nwith (obj) {\n__p += '<div class=\"alert alert-danger\" role=\"alert\">\\r\\n  <h2>An error ocurred.</h2>\\r\\n</div>\\r\\n';\n\n}\nreturn __p\n},\n\"home/templates/home\": function(obj) {\nobj || (obj = {});\nvar __t, __p = '', __e = _.escape;\nwith (obj) {\n__p += '\\r\\n<div class=\"jumbotron\" id=\"hero\">\\r\\n  <h1 class=\"page-header\">My Open Data</h1>\\r\\n  <p>\\r\\n    <div class=\"input-group input-group-lg\">\\r\\n      <label class=\"sr-only\" for=\"search\">Search</label>\\r\\n      <input type=\"search\" name=\"search\" id=\"search\" class=\"form-control\" placeholder=\"search for open data\">\\r\\n      <span class=\"input-group-btn\">\\r\\n        <button id=\"search-btn\" class=\"btn btn-default\" type=\"button\">\\r\\n          <span class=\"glyphicon glyphicon-search\" aria-hidden=\"true\"></span>\\r\\n        </button>\\r\\n      </span>\\r\\n    </div>\\r\\n  </p>\\r\\n  <span style=\"float:right;color:#FFF\">Image <a href=\"https://www.flickr.com/photos/davebloggs007/14389618573\">CC Dave Bloggs</a></span>\\r\\n</div>\\r\\n<div class=\"row\">\\r\\n  \\r\\n</div>\\r\\n';\n\n}\nreturn __p\n},\n\"results/templates/results-empty\": function(obj) {\nobj || (obj = {});\nvar __t, __p = '', __e = _.escape;\nwith (obj) {\n__p += '<td colspan=\"7\" class=\"text-center\">...</td>';\n\n}\nreturn __p\n},\n\"results/templates/results-item\": function(obj) {\nobj || (obj = {});\nvar __t, __p = '', __e = _.escape;\nwith (obj) {\n__p += '<td>' +\n((__t = ( name )) == null ? '' : __t) +\n'</td>\\r\\n<td>' +\n((__t = ( owner )) == null ? '' : __t) +\n'</td>\\r\\n<td>' +\n((__t = ( record_count )) == null ? '' : __t) +\n'</td>\\r\\n<td>' +\n((__t = ( item_type )) == null ? '' : __t) +\n'</td>\\r\\n<td>' +\n((__t = ( views )) == null ? '' : __t) +\n'</td>\\r\\n<td>' +\n((__t = ( moment(created_at).fromNow() )) == null ? '' : __t) +\n'</td>\\r\\n<td>' +\n((__t = ( moment(updated_at).fromNow() )) == null ? '' : __t) +\n'</td>';\n\n}\nreturn __p\n},\n\"results/templates/results-loading\": function(obj) {\nobj || (obj = {});\nvar __t, __p = '', __e = _.escape;\nwith (obj) {\n__p += '<td colspan=\"7\" class=\"text-center\">\\r\\n  <div class=\"progress\">\\r\\n    <div class=\"progress-bar progress-bar-striped active\" role=\"progressbar\" aria-valuenow=\"40\" aria-valuemin=\"0\" aria-valuemax=\"100\" style=\"width: 45%\">\\r\\n      <span class=\"sr-only\">45% Complete</span>\\r\\n    </div>\\r\\n  </div>\\r\\n</td>';\n\n}\nreturn __p\n},\n\"results/templates/results\": function(obj) {\nobj || (obj = {});\nvar __t, __p = '', __e = _.escape, __j = Array.prototype.join;\nfunction print() { __p += __j.call(arguments, '') }\nwith (obj) {\n__p += '<h2>\\r\\n  ';\n if (!collectionIsLoading) { ;\n__p += '\\r\\n    Your search for <em>\"' +\n((__t = ( q )) == null ? '' : __t) +\n'\"</em> yielded ' +\n((__t = ( total_count.toLocaleString() )) == null ? '' : __t) +\n' datasets\\r\\n  ';\n } ;\n__p += '\\r\\n</h2>\\r\\n\\r\\n<div class=\"table-responsive\">  \\r\\n  <table class=\"table table-striped table-bordered table-hover\">\\r\\n    <thead>\\r\\n      <tr>\\r\\n        <th>NAME</th>\\r\\n        <th>OWNER</th>\\r\\n        <th>RECORDS</th>\\r\\n        <th>LAYER TYPE</th>\\r\\n        <th>VIEWS</th>\\r\\n        <th>CREATED</th>\\r\\n        <th>UPDATED</th>\\r\\n      </tr>\\r\\n    </thead>\\r\\n    <tbody></tbody>\\r\\n  </table>\\r\\n</div>\\r\\n<nav>\\r\\n  <ul class=\"pagination\">\\r\\n    ';\n if (pages.length > 1) { ;\n__p += '\\r\\n      <li id=\"page-prev\" class=\"' +\n((__t = ( firstPage )) == null ? '' : __t) +\n'\"><a href=\"' +\n((__t = ( prevUrl )) == null ? '' : __t) +\n'\" data-page=\"' +\n((__t = ( prevPage )) == null ? '' : __t) +\n'\"><span aria-hidden=\"true\">&laquo;</span></a></li>\\r\\n      \\r\\n      ';\n _.each(pages, function (page) { ;\n__p += '\\r\\n        <li class=\"' +\n((__t = ( page.active )) == null ? '' : __t) +\n'\"><a href=\"' +\n((__t = ( page.url )) == null ? '' : __t) +\n'\" class=\"page-number\" data-page=\"' +\n((__t = ( page.page )) == null ? '' : __t) +\n'\">' +\n((__t = ( page.page )) == null ? '' : __t) +\n'</a></li>\\r\\n      ';\n }); ;\n__p += '\\r\\n\\r\\n      <li id=\"page-next\" class=\"' +\n((__t = ( lastPage )) == null ? '' : __t) +\n'\"><a href=\"' +\n((__t = ( nextUrl )) == null ? '' : __t) +\n'\" data-page=\"' +\n((__t = ( nextPage )) == null ? '' : __t) +\n'\"><span aria-hidden=\"true\">&raquo;</span></a></li>\\r\\n    ';\n } ;\n__p += '\\r\\n  </ul>\\r\\n</nav>';\n\n}\nreturn __p\n}};\n\r\n(function () {\r\n\r\n  'use strict';\r\n    \r\n  MyOD.module('Main', function (Main, App, Backbone, Marionette, $, _) {\r\n          \r\n    Main.HeaderSearchView = MyOD.Base.SearchView.extend({ \r\n\r\n      initialize: function () {\r\n        this.listenTo(this.model, 'change:q', this.onQueryChanged);\r\n      },\r\n\r\n      el: '#header-search-container',\r\n\r\n      template: false,\r\n\r\n      events: {\r\n        'keydown #header-search': 'onKeyDown',\r\n        'keyup #header-search': 'onKeyUp',\r\n        'click #header-search-btn': 'onSearchButtonClick',\r\n        'typeahead:selected input': 'onTypeaheadSelected'\r\n      },\r\n\r\n      ui: {\r\n        search: '#header-search'\r\n      },\r\n\r\n      onQueryChanged: function () {\r\n        this.ui.search.typeahead('val', this.model.get('q'));\r\n      }\r\n\r\n    });\r\n\r\n  });\r\n\r\n})();\r\n\n\r\n(function () {\r\n\r\n  'use strict';\r\n    \r\n  MyOD.module('Main', function (Main, App, Backbone, Marionette, $, _) {\r\n\r\n    Main.Layout = Marionette.LayoutView.extend({\r\n      \r\n      initialize: function () {\r\n        _.bindAll(this, 'setClasses');\r\n        this.headerSearchView = new Main.HeaderSearchView({ model: App.searchModel }).render();\r\n      },\r\n\r\n      el: 'body',\r\n\r\n      regions: {\r\n        main: '#main-region'\r\n      },\r\n\r\n      events: {\r\n        'click #home-link': 'navigateHome'\r\n      },\r\n\r\n      navigateHome: function (e) {\r\n        if (!e.metaKey && !e.ctrlKey) {\r\n          e.preventDefault();\r\n          App.navigate('', { trigger: true });\r\n        }\r\n      },\r\n\r\n      setClasses: function () {\r\n        var self = this;\r\n        if (Backbone.history.getFragment().indexOf('datasets') === 0) {\r\n          self.$el.removeClass('page-home');\r\n        } else {\r\n          self.$el.addClass('page-home');\r\n        }\r\n      }\r\n\r\n    });\r\n\r\n  });\r\n\r\n})();\r\n\n\r\n(function () {\r\n\r\n  'use strict';\r\n    \r\n  MyOD.module('HomeModule', function (HomeModule, App, Backbone, Marionette, $, _) {\r\n          \r\n    HomeModule.View = MyOD.Base.SearchView.extend({ \r\n\r\n      initialize: function () {\r\n        this.model = App.searchModel;   \r\n      },\r\n\r\n      template: JST['home/templates/home'],\r\n\r\n      events: {\r\n        'keydown #search': 'onKeyDown',\r\n        'keyup #search': 'onKeyUp',\r\n        'click #search-btn': 'onSearchButtonClick',\r\n        'typeahead:selected input': 'onTypeaheadSelected'\r\n      },\r\n\r\n      ui: {\r\n        search: '#search'\r\n      },\r\n\r\n      id: 'home',\r\n\r\n      onDomRefresh: function () {\r\n        this.ui.search.focus();\r\n      }\r\n\r\n    });\r\n\r\n  });\r\n\r\n})();\r\n\n\r\n(function () {\r\n\r\n  'use strict';\r\n    \r\n  MyOD.module('HomeModule', function (HomeModule, App, Backbone, Marionette, $, _) {\r\n          \r\n    HomeModule.Controller = Marionette.Controller.extend({ \r\n\r\n      initUi: function () {\r\n        var view = new HomeModule.View();\r\n        App.layout.getRegion('main').show(view);\r\n      }\r\n\r\n    });\r\n\r\n  });\r\n\r\n})();\r\n\n\r\n(function () {\r\n    \r\n  'use strict';\r\n\r\n  MyOD.module('HomeModule', function (HomeModule, App, Backbone, Marionette, $, _) {\r\n      \r\n    //Router for the module\r\n    HomeModule.Router = Backbone.Marionette.AppRouter.extend({\r\n      appRoutes:{\r\n        '': 'show'\r\n      }\r\n    });\r\n\r\n    //Add the router during the initialization \r\n    HomeModule.addInitializer(function (options) {\r\n      var router = new HomeModule.Router({ controller: HomeModule.API }); \r\n    });\r\n\r\n    //Simple API object that provides the implementation for the routes\r\n    HomeModule.API = {\r\n\r\n      show: function(options){\r\n\r\n        if(!this.homeController){\r\n          this.homeController = new HomeModule.Controller(options);\r\n        }\r\n\r\n        this.homeController.initUi(options);\r\n      }\r\n    };\r\n\r\n  });\r\n})();\n\r\n(function () {\r\n\r\n  'use strict';\r\n    \r\n  MyOD.module('Models', function (Models, App, Backbone, Marionette, $, _) {\r\n          \r\n    Models.DatasetModel = Backbone.Model.extend({\r\n\r\n      defaults: {\r\n        id: '',\r\n        name: '',\r\n        description: '',\r\n        tags: [],\r\n        arcgis_online_item_url: '',\r\n        owner: '',\r\n        url: '',\r\n        created_at: '',\r\n        updated_at: '',\r\n        views: 0,\r\n        thumbnail_url: ''\r\n      },\r\n\r\n      parse: function (response) {\r\n        return response.data || response;\r\n      },\r\n\r\n      url: function () {\r\n        return MyOD.config.api + 'datasets/' + this.get('id') + '.json';\r\n      },\r\n\r\n      getNumericFields: function () {\r\n        var fields = this.get('fields');\r\n        return _.filter(fields, function (item) {\r\n          return _.contains([ 'esriFieldTypeSingle', 'esriFieldTypeDouble', 'esriFieldTypeInteger' ], item.type);\r\n        });\r\n      }\r\n\r\n    });\r\n\r\n  });\r\n\r\n})();\r\n\n\r\n(function () {\r\n\r\n  'use strict';\r\n    \r\n  MyOD.module('Models', function (Models, App, Backbone, Marionette, $, _) {\r\n          \r\n    Models.DatasetCollection = Backbone.Collection.extend({\r\n\r\n      model: Models.DatasetModel,\r\n\r\n      url: function () {\r\n        return App.searchModel.getUrl(true);\r\n      },\r\n\r\n      parse: function (resp) {\r\n        //apply the metadata to the searchmodel\r\n        App.searchModel.set(_.extend(resp.metadata.query_parameters, resp.metadata.stats));\r\n        return resp.data;\r\n      }\r\n\r\n    });\r\n\r\n  });\r\n\r\n})();\r\n\n\r\n(function () {\r\n\r\n  'use strict';\r\n    \r\n  MyOD.module('ResultsModule', function (ResultsModule, App, Backbone, Marionette, $, _) {\r\n\r\n    ResultsModule.ItemView = Marionette.ItemView.extend({ \r\n\r\n      template: JST['results/templates/results-item'],\r\n\r\n      model: MyOD.Models.DatasetModel,\r\n\r\n      tagName: 'tr',\r\n\r\n      events: {\r\n        click: 'onClick'\r\n      },\r\n\r\n      onClick: function () {\r\n        this.trigger('result:clicked', this.model);\r\n      }\r\n\r\n    });\r\n\r\n    ResultsModule.LoadingView = Marionette.ItemView.extend({ \r\n\r\n      template: JST['results/templates/results-loading'],\r\n\r\n      tagName: 'tr',\r\n\r\n      className: 'loading'\r\n\r\n    });\r\n\r\n    ResultsModule.EmptyView = Marionette.ItemView.extend({ \r\n\r\n      template: JST['results/templates/results-empty'],\r\n\r\n      tagName: 'tr'\r\n\r\n    });\r\n\r\n    ResultsModule.View = Marionette.CompositeView.extend({ \r\n\r\n      initialize: function () {\r\n        this.listenTo(this, 'childview:result:clicked', this.selectDataset);\r\n      },\r\n\r\n      collectionIsLoading: true,\r\n\r\n      template: JST['results/templates/results'],\r\n\r\n      childView: ResultsModule.ItemView,\r\n\r\n      childViewContainer: 'tbody',\r\n\r\n      getEmptyView: function () {\r\n        if (this.collectionIsLoading) {\r\n          return ResultsModule.LoadingView;\r\n        } else {\r\n          return ResultsModule.EmptyView;\r\n        }\r\n      },\r\n\r\n      events: {\r\n        'click ul.pagination a': 'onPageClicked'\r\n      },\r\n\r\n      modelEvents: {\r\n        'change:total_count': 'render'\r\n      },\r\n\r\n      collectionEvents: {\r\n        'sync': 'onCollectionSync',\r\n        'error': 'onCollectionSync'\r\n      },\r\n\r\n      id: 'page-results',\r\n\r\n      onCollectionSync: function () {\r\n        this.collectionIsLoading = false;\r\n        this.render();\r\n      },\r\n\r\n      selectDataset: function (childView, childModel) {\r\n        App.navigate('/datasets/' + childModel.get('id'), { trigger: true });\r\n      },\r\n\r\n      onPageClicked: function (e) {\r\n        //allow cmd-click to open in new window\r\n        if(!(e.metaKey || e.ctrlKey)){\r\n          e.stopPropagation();\r\n          e.preventDefault();\r\n          var page = $(e.target).closest('a').data('page');\r\n          //not sure why i was doing it this way...\r\n          //var model = App.searchModel.clone();\r\n          //App.navigate(model.getRoute(false), { trigger: true });\r\n          this.model.set('page', page);\r\n          App.search();\r\n        }\r\n      },\r\n\r\n      templateHelpers: function () {\r\n        //serialize the model into what we need for the template\r\n        var info = App.searchModel.toJSON();\r\n\r\n        var len = Math.round(info.total_count);\r\n        var page = +info.page;\r\n        var from = (page === 0) ? page + 1 : page;\r\n        var size = info.per_page;\r\n        var total_pages = Math.ceil(len / size);\r\n        var pages = [];\r\n        \r\n        //don't show more than 10?\r\n        var start = ( total_pages > 10 && from > 6 ) ? from - 5 : 1;\r\n        var end = ( total_pages > start + 9 ) ? start + 9 : total_pages;\r\n\r\n        // build the pages array\r\n        var searchModel = this.model.clone();\r\n        var active;\r\n        for (var i = start; i <= end; i++) {\r\n          active = (i === from) ? 'active' : '';\r\n          searchModel.set('page', i);\r\n          pages.push({ url: searchModel.getRoute(false), page: i, active: active });\r\n        }\r\n\r\n        var prevUrl = this.model.getRoute(false);\r\n        var prevPage = page;\r\n        if (from !== 1) { \r\n          prevPage = page-1;\r\n          searchModel.set('page', prevPage);\r\n          prevUrl = searchModel.getUrl();\r\n        }\r\n        var nextUrl = this.model.getRoute(false);\r\n        var nextPage = page;\r\n        if (total_pages !== from) {\r\n          nextPage = page + 1;\r\n          searchModel.set('page', nextPage);\r\n          nextUrl = searchModel.getUrl();\r\n        }\r\n\r\n        return {\r\n          firstPage: (from === 1) ? 'disabled' : '',\r\n          lastPage: (total_pages === from) ? 'disabled' : '',\r\n          prevUrl: prevUrl,\r\n          nextUrl: nextUrl,\r\n          prevPage: prevPage,\r\n          nextPage: nextPage,\r\n          pages: pages,\r\n          collectionIsLoading: this.collectionIsLoading\r\n        };\r\n      }\r\n\r\n    });\r\n\r\n  });\r\n\r\n})();\r\n\n\r\n(function () {\r\n\r\n  'use strict';\r\n    \r\n  MyOD.module('ResultsModule', function (ResultsModule, App, Backbone, Marionette, $, _) {\r\n          \r\n    ResultsModule.Controller = Marionette.Controller.extend({ \r\n\r\n      initUi: function (options) {\r\n        this.collection = new App.Models.DatasetCollection();\r\n        this.collection.fetch({ cache: true });\r\n        this.view = new ResultsModule.View({ model: App.searchModel, collection: this.collection });\r\n        App.layout.getRegion('main').show(this.view);\r\n      }\r\n\r\n    });\r\n\r\n  });\r\n\r\n})();\r\n\n\r\n(function () {\r\n    \r\n  'use strict';\r\n\r\n  MyOD.module('ResultsModule', function (ResultsModule, App, Backbone, Marionette, $, _) {\r\n      \r\n    //Router for the module\r\n    ResultsModule.Router = Backbone.Marionette.AppRouter.extend({\r\n      appRoutes:{\r\n        'datasets(/)': 'show'\r\n      }\r\n    });\r\n\r\n    //Add the router during the initialization \r\n    ResultsModule.addInitializer(function (options) {\r\n      var router = new ResultsModule.Router({ controller: ResultsModule.API }); \r\n    });\r\n\r\n    //Simple API object that provides the implementation for the routes\r\n    ResultsModule.API = {\r\n\r\n      show: function(options){\r\n\r\n        var queryObj = App.queryStringToObject();\r\n        //don't encode the q\r\n        // var q = App.searchModel.get('q');\r\n        // App.searchModel.set(_.extend(queryObj, { q: q }));\r\n        App.searchModel.set(queryObj);\r\n\r\n        if(!this.resultsController){\r\n          this.resultsController = new ResultsModule.Controller(options);\r\n        }\r\n\r\n        this.resultsController.initUi(options);\r\n      }\r\n\r\n    };\r\n\r\n  });\r\n})();\n\r\n(function () {\r\n\r\n  'use strict';\r\n    \r\n  MyOD.module('Models', function (Models, App, Backbone, Marionette, $, _) {\r\n          \r\n    Models.DatasetRow = Backbone.Model.extend({\r\n\r\n      \r\n\r\n    });\r\n\r\n  });\r\n\r\n})();\r\n\n\r\n(function () {\r\n\r\n  'use strict';\r\n    \r\n  MyOD.module('Models', function (Models, App, Backbone, Marionette, $, _) {\r\n          \r\n    Models.RowCollection = Backbone.Collection.extend({\r\n\r\n      initialize: function (attributes, options) {\r\n        this.dataset = options.dataset;\r\n        \r\n        var queryCapabilities = this.dataset.get('advanced_query_capabilities');\r\n        this.supportsPagination = queryCapabilities && queryCapabilities.supports_pagination;\r\n\r\n        this.orderBy = this.dataset.get('object_id_field');\r\n      },\r\n\r\n      perPage: 10,\r\n\r\n      page: 0,\r\n\r\n      orderBy: '',\r\n\r\n      orderByAsc: true,\r\n\r\n      model: Models.DatasetRow,\r\n\r\n      getQueryUrl: function () {\r\n        var url = this.dataset.get('url');\r\n        url += '/query?where=1%3D1&text=&objectIds=&time=&geometry=&geometryType=esriGeometryEnvelope&inSR=&spatialRel=esriSpatialRelIntersects&relationParam=&outFields=*&returnGeometry=false&maxAllowableOffset=&geometryPrecision=&outSR=&returnIdsOnly=false&returnCountOnly=false&groupByFieldsForStatistics=&outStatistics=&returnZ=false&returnM=false&gdbVersion=&returnDistinctValues=false&f=pjson';\r\n\r\n        if (this.supportsPagination) {\r\n          url += '&resultOffset=' + this.page * this.perPage;\r\n          url += '&resultRecordCount=' + this.perPage;\r\n          //NOTE: when you pass in one of the above two parameters and orderByFields is left empty, \r\n          //map service uses the object-id field to sort the result. \r\n          //For a query layer with a pseudo column as the object-id field (e.g., FID), \r\n          //you must provide orderByFields; otherwise the query fails\r\n        }\r\n\r\n        var orderBy = this.orderBy;\r\n        if (!this.orderByAsc) {\r\n          orderBy += ' desc';\r\n        }\r\n        //NOTE: this still could fail \r\n        //if the oid field has changed since it was harvested by open data\r\n        //or it is null (which should not happen...)\r\n        url += '&orderByFields=' + orderBy;\r\n\r\n        return url;\r\n      },\r\n\r\n      url: function () {\r\n        return this.getQueryUrl();\r\n      },\r\n\r\n      parse: function (resp) {\r\n        // this.fields = resp.fields;\r\n        // this.fieldAliases = resp.fieldAliases;\r\n        var rows = resp.features;\r\n        if (!this.supportsPagination) {\r\n          //this is slightly crappy but \r\n          //for datasets that don't support pagination\r\n          //we just show the first n rows with no pagination\r\n          //even though we got maxRecordCount rows\r\n          rows = _.first(rows, this.perPage);\r\n        }\r\n        return rows;\r\n      }\r\n\r\n    });\r\n\r\n  });\r\n\r\n})();\r\n\n\r\n(function () {\r\n\r\n  'use strict';\r\n    \r\n  MyOD.module('DatasetsModule', function (DatasetsModule, App, Backbone, Marionette, $, _) {\r\n         \r\n    DatasetsModule.TableRowView = Marionette.ItemView.extend({ \r\n\r\n      initialize: function (options) {\r\n        this.dataset = options.dataset;\r\n        this.fields = this.dataset.get('fields');\r\n      },\r\n\r\n      template: JST['datasets/templates/table-row'],\r\n\r\n      templateHelpers: function () {\r\n        var self = this;\r\n        return {\r\n          fields: self.fields\r\n        };\r\n      },\r\n\r\n      model: MyOD.Models.DatasetRow,\r\n\r\n      tagName: 'tr'\r\n\r\n    });\r\n\r\n    DatasetsModule.TableView = Marionette.CompositeView.extend({\r\n\r\n      initialize: function (options) {\r\n        this.collection = new App.Models.RowCollection([], { dataset: this.model });\r\n        this.collection.fetch();\r\n      },\r\n\r\n      events: {\r\n        'click ul.pagination li a': 'onPageClicked',\r\n        'click thead th': 'sort'\r\n      },\r\n\r\n      collectionEvents: {\r\n        //we need the pagination to re-render\r\n        'reset': 'render'\r\n      },\r\n\r\n      template: JST['datasets/templates/table'],\r\n\r\n      childView: DatasetsModule.TableRowView,\r\n\r\n      childViewOptions: function () {\r\n        var dataset = this.model;\r\n        return {\r\n          dataset: dataset\r\n        };\r\n      },\r\n\r\n      templateHelpers: function () {\r\n\r\n        //defaults - this is what will be rendered if the dataset does not support pagination\r\n        var obj = {\r\n          firstPage: '',\r\n          lastPage: '',\r\n          prevPage: 0,\r\n          nextPage: 0,\r\n          pages: [],\r\n          showPagination: false,\r\n          from: 1,\r\n          to: this.collection.perPage,\r\n          total: this.model.get('record_count'),\r\n          sortField: this.collection.orderBy,\r\n          sortClass: this.collection.orderByAsc ? 'sort_asc' : 'sort_desc',\r\n          sortIconClass: this.collection.orderByAsc ? 'glyphicon-arrow-down' : 'glyphicon-arrow-up',\r\n        };\r\n\r\n        if (this.collection.supportsPagination) {\r\n          var totalPages = Math.ceil(this.model.get('record_count') / this.collection.perPage);\r\n          //zero based page index\r\n          var page = this.collection.page;\r\n\r\n          //don't show more than 10 pages in paginator?\r\n          var start = (totalPages > 10 && page > 6) ? page - 5 : 1;\r\n          var end = (totalPages > start + 9) ? start + 9 : totalPages;\r\n\r\n          var active, pages = [];\r\n          for (var i = start; i <= end; i++) {\r\n            active = (i === page + 1) ? 'active' : '';\r\n            pages.push({ page: i, active: active });\r\n          }\r\n\r\n          var total = this.model.get('record_count');\r\n          var from = page * this.collection.perPage + 1;\r\n          var to = page * this.collection.perPage + this.collection.perPage;\r\n          to = (to <= total) ? to : total;\r\n\r\n          obj = {\r\n            firstPage: (page === 0) ? 'disabled' : '',\r\n            lastPage: (totalPages === page + 1) ? 'disabled' : '',\r\n            prevPage: page,\r\n            nextPage: page + 2,\r\n            pages: pages,\r\n            showPagination: true,\r\n            from: from,\r\n            to: to,\r\n            total: total,\r\n            sortField: this.collection.orderBy,\r\n            sortClass: this.collection.orderByAsc ? 'sort_asc' : 'sort_desc',\r\n            sortIconClass: this.collection.orderByAsc ? 'glyphicon-chevron-down' : 'glyphicon-chevron-up',\r\n          };\r\n        }\r\n\r\n        return obj;\r\n      },\r\n\r\n      childViewContainer: 'tbody',\r\n\r\n      onPageClicked: function (e) {\r\n        var anchor = $(e.target).closest('a');\r\n        var li = anchor.closest('li');\r\n        if (!li.hasClass('disabled') && !li.hasClass('active')) {\r\n          var page = anchor.data('page') - 1;\r\n          this.collection.page = page;\r\n          this.collection.fetch({ reset: true });\r\n        }\r\n      },\r\n\r\n      sort: function (e) {\r\n        var orderBy = $(e.target).data('fieldName');\r\n        if (orderBy) {\r\n          if (orderBy === this.collection.orderBy) {\r\n            this.collection.orderByAsc = !this.collection.orderByAsc;\r\n          } else {\r\n            this.collection.orderByAsc = true;\r\n          }\r\n          this.collection.page = 0;\r\n          this.collection.orderBy = orderBy;\r\n          this.collection.fetch({ reset: true });\r\n        }\r\n      }\r\n      \r\n    });\r\n\r\n  });\r\n\r\n})();\r\n\n\r\n(function () {\r\n\r\n  'use strict';\r\n    \r\n  MyOD.module('DatasetsModule', function (DatasetsModule, App, Backbone, Marionette, $, _) {\r\n          \r\n    DatasetsModule.View = Marionette.ItemView.extend({\r\n\r\n      initialize: function (options) {\r\n        _.bindAll(this, 'changeAttribute', 'changeRamp');\r\n        this.mapManager = options.mapManager;\r\n      },\r\n\r\n      template: JST['datasets/templates/dataset'],\r\n\r\n      id: 'page-dataset',\r\n\r\n      ui: {\r\n        'mapDiv': '#map',\r\n        'tableContainer': '#table-container'\r\n      },\r\n\r\n      modelEvents: {\r\n        'change': 'render'\r\n      },\r\n\r\n      templateHelpers: function () {\r\n        var baseUrl = this.model.url().replace(/.json$/, '');\r\n        return {\r\n          baseUrl: baseUrl \r\n        };\r\n      },\r\n\r\n      onRender: function () {\r\n        //TODO: refactor to use regions...\r\n        this.tableView = new DatasetsModule.TableView({ el: this.ui.tableContainer, model: this.model }).render();\r\n      },\r\n\r\n      // onShow: function () {\r\n      //   console.debug('onShow');\r\n      // },\r\n\r\n      onDomRefresh: function () {\r\n        if (this.model.get('item_type').toLowerCase() !== 'table') {\r\n          var self = this;\r\n          // TODO: would be nice to encapsulate this in mapmanager so consumers wouldn't have to know to do it\r\n          this.ui.mapDiv.show();\r\n          this.mapManager.dojoReady.done(function () {\r\n            self.mapManager.createMap('map', { coords: self.model.get('extent').coordinates });\r\n            self.mapManager.addDataset(self.model);\r\n\r\n            //self.initSmaps();\r\n          });\r\n        }\r\n      },\r\n\r\n      initSmaps: function (basemap) {\r\n        var numerics = this.model.getNumericFields();\r\n\r\n        if (numerics.length){\r\n\r\n          // select the first attr to map \r\n          // we could put some logic around which to use here\r\n          this.fieldName = this.fieldName || numerics[0].name;\r\n          \r\n          //get stats for selected attribute\r\n          var fields = this.model.get('fields');\r\n          this.stats = this.getStats(fields, this.fieldName);\r\n          this.type = this.getGeometryType(this.model.get('geometry_type'));\r\n\r\n\r\n          var yukiOptions = {\r\n            fields: numerics,\r\n            field: this.fieldName,\r\n            statistics: this.stats,\r\n            type: this.type,\r\n            schemes: this.getSchemes()\r\n          };\r\n\r\n          if (!this.yuki) {\r\n            this.yuki = new Yuki('smaps', yukiOptions);\r\n          } else {\r\n            $('#yuki-viz-tools').remove();\r\n            this.yuki = new Yuki('smaps', yukiOptions);\r\n          }\r\n\r\n          // EVENT Handlers from yuki\r\n          this.yuki.on('change', this.changeAttribute);\r\n          this.yuki.on('ramp-change', this.changeRamp);\r\n\r\n          this._execStyleMap();\r\n        }\r\n\r\n      },\r\n\r\n      getStats: function (fields, fieldName) {\r\n        var fieldObj = _.findWhere(fields, { name: fieldName });\r\n        return fieldObj ? fieldObj.statistics : null;\r\n      },\r\n\r\n      getGeometryType: function (geomType) {\r\n        switch (geomType) {\r\n          case 'esriGeometryPoint':\r\n          case 'esriGeometryMultipoint':\r\n            return 'point';\r\n          case 'esriGeometryPolyline':\r\n            return 'line';\r\n          case 'esriGeometryPolygon':\r\n            return 'polygon';\r\n          default:\r\n            return geomType.toLowerCase();\r\n        }\r\n      },\r\n\r\n      getSchemes: function (){\r\n        var theme, styleType, self = this;\r\n        switch (this.type){\r\n          case 'point':\r\n            theme = 'default';\r\n            styleType = 'size';\r\n            break;\r\n          case 'polygon':\r\n            theme = 'high-to-low';\r\n            styleType = 'choropleth';\r\n            break;\r\n        }\r\n\r\n        //TODO: move this into mapmanager\r\n        return esri.styles[styleType].getSchemes({\r\n          theme: theme, \r\n          basemap: 'dark-gray', \r\n          geometryType: self.type\r\n        });\r\n      },\r\n\r\n      // handler for attr change \r\n      changeAttribute: function (fieldName) {\r\n        //update stats for selected attribute\r\n        var fields = this.model.get('fields');\r\n        this.stats = this.getStats(fields, fieldName);\r\n        this.fieldName = fieldName;\r\n\r\n        this._execStyleMap(this.selectedScheme);\r\n      },\r\n\r\n      // handler for ramp UI change\r\n      changeRamp: function (index) {\r\n        this.selectedScheme = this.getSchemes().secondarySchemes[index];\r\n        this._execStyleMap(this.selectedScheme);\r\n      },\r\n\r\n      //update the map in mapmanager\r\n      _execStyleMap: function (scheme) {\r\n        var self = this;\r\n\r\n        var opts = {\r\n          field: this.fieldName,\r\n          basemap: 'dark-gray',\r\n          statistics: this.stats,\r\n          type: this.type\r\n        };\r\n      \r\n        if (scheme){\r\n          opts.scheme = scheme;\r\n        }\r\n        \r\n        var foo = App.reqres.request('smaps:update:style', opts)\r\n          .done(function(renderer){\r\n            if (self.type === 'point'){\r\n              self.yuki.buildPointLegend(renderer.breaks);\r\n            }\r\n          });\r\n      },\r\n\r\n      onDestroy: function () {\r\n        this.mapManager.destroy();\r\n        this.tableView.destroy();\r\n      }\r\n      \r\n    });\r\n\r\n  });\r\n\r\n})();\r\n\n\r\n(function () {\r\n\r\n  'use strict';\r\n    \r\n  MyOD.module('DatasetsModule', function (DatasetsModule, App, Backbone, Marionette, $, _) {\r\n\r\n    DatasetsModule.Controller = Marionette.Controller.extend({ \r\n\r\n      initialize: function () {\r\n        _.bindAll(this, 'onModelFetched');\r\n      },\r\n\r\n      initUi: function (options) {\r\n        this.mapManager = new App.Utils.MapManager();\r\n        this.model = new App.Models.DatasetModel({ id: options });\r\n        this.model\r\n          .fetch()\r\n            .done(this.onModelFetched)\r\n            .fail(function () {\r\n              App.navigate404();\r\n            });\r\n      },\r\n\r\n      onModelFetched: function () {\r\n        var view = new DatasetsModule.View({ model: this.model, mapManager: this.mapManager });\r\n        App.layout.getRegion('main').show(view);\r\n      },\r\n\r\n      onBeforeDestroy: function () {\r\n        if (this.mapManager) {\r\n          this.mapManager.destroy();\r\n        }\r\n      }\r\n\r\n    });\r\n\r\n  });\r\n\r\n})();\r\n\n\r\n(function () {\r\n    \r\n  'use strict';\r\n\r\n  MyOD.module('DatasetsModule', function (DatasetsModule, App, Backbone, Marionette, $, _) {\r\n      \r\n    //Router for the module\r\n    DatasetsModule.Router = Backbone.Marionette.AppRouter.extend({\r\n      appRoutes:{\r\n        'datasets/:id(/)': 'show',\r\n      }\r\n    });\r\n\r\n    //Add the router during the initialization \r\n    DatasetsModule.addInitializer(function (options) {\r\n      var router = new DatasetsModule.Router({ controller: DatasetsModule.API }); \r\n    });\r\n\r\n    //Simple API object that provides the implementation for the routes\r\n    DatasetsModule.API = {\r\n\r\n      show: function(options){\r\n\r\n        if(!this.datasetsController){\r\n          this.datasetsController = new DatasetsModule.Controller(options);\r\n        }\r\n\r\n        this.datasetsController.initUi(options);\r\n      }\r\n    };\r\n\r\n  });\r\n})();\n\r\n(function () {\r\n\r\n  'use strict';\r\n    \r\n  MyOD.module('ErrorModule', function (ErrorModule, App, Backbone, Marionette, $, _) {\r\n          \r\n    ErrorModule.View = Marionette.ItemView.extend({\r\n      \r\n      id: 'page-error',\r\n\r\n      getTemplate: function(){\r\n        var errorCode = this.model.get('errorCode');\r\n        var template;\r\n\r\n        switch (errorCode) {\r\n          case 404:\r\n              template = JST['error/templates/404'];\r\n            break;\r\n          default:\r\n              template = JST['error/templates/500'];\r\n        }\r\n\r\n        return template;\r\n      }\r\n\r\n    });\r\n\r\n  });\r\n\r\n})();\r\n\n\r\n(function () {\r\n\r\n  'use strict';\r\n    \r\n  MyOD.module('ErrorModule', function (ErrorModule, App, Backbone, Marionette, $, _) {\r\n\r\n    ErrorModule.Controller = Marionette.Controller.extend({ \r\n\r\n      initUi: function (options) {\r\n        // init the results view in here so it re-binds on \"back button\"\r\n        var model = new Backbone.Model({ errorCode: options.errorCode });\r\n        var view = new ErrorModule.View({ model: model });\r\n\r\n        App.layout.getRegion('main').show(view);\r\n      }\r\n\r\n    });\r\n\r\n  });\r\n\r\n})();\r\n\n\r\n(function () {\r\n    \r\n  'use strict';\r\n\r\n  MyOD.module('ErrorModule', function (ErrorModule, App, Backbone, Marionette, $, _) {\r\n      \r\n    //Router for the module\r\n    ErrorModule.Router = Backbone.Marionette.AppRouter.extend({\r\n      appRoutes:{\r\n        '404': 'error404',\r\n        '500': 'error500'\r\n      }\r\n    });\r\n\r\n    //Add the router during the initialization \r\n    ErrorModule.addInitializer(function (options) {\r\n      var router = new ErrorModule.Router({ controller: ErrorModule.API }); \r\n    });\r\n\r\n    //Simple API object that provides the implementation for the routes\r\n    ErrorModule.API = {\r\n\r\n      initController: function () {\r\n        if(!this.errorController){\r\n          this.errorController = new ErrorModule.Controller();\r\n        }\r\n      },\r\n\r\n      error404: function () {\r\n        this.initController();\r\n        this.errorController.initUi({ errorCode: 404 });\r\n      },\r\n\r\n      error500: function () {\r\n        this.initController();\r\n        this.errorController.initUi({ errorCode: 500 });\r\n      }\r\n    };\r\n\r\n  });\r\n})();\n\r\n$(function () {\r\n  'use strict';\r\n\r\n  MyOD.start();\r\n});"],"sourceRoot":"/source/"}